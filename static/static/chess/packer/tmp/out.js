var lib_utils={swtch:function(){}},lib_maths={randomInt:function(a,b){return Math.round(Math.random()*parseFloat(b-a)+parseFloat(a))},radToDeg:function(a){return a*180/Math.PI},degToRad:function(a){return a*Math.PI/180},round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c},piterval:function(a){for(;a<-Math.PI;)a+=2*Math.PI;for(;a>Math.PI;)a-=2*Math.PI;return a},piterval2:function(a){for(;a<-Math.PI*0.5;)a+=Math.PI;for(;a>Math.PI*0.5;)a-=Math.PI;return a},decimalPart:function(a){return a-
Math.round(a)},pow2:function(a){return a*a},clamp:function(a,b,c){return Math.min(Math.max(a,b),c)},pythagore:function(a,b){return Math.sqrt(a*a+b*b)},angle_near_right:function(a){return Math.abs(a)%(Math.PI/2)}},lib_objs={overload:function(a,b){for(var c in a)b[c]=a[c]},mapMethod:function(a,b){for(var c in a)a[c][b]()},copyAttributes:function(a,b){return this.copyAttributesRec(a,a instanceof Array?[]:{},b,[],[])},copyAttributesRec:function(a,b,c,d,e){var f;if(!a)return b;if(!c(a))return b;for(var g in a)if(typeof a[g]!=
"function")if(typeof a[g]=="object"){if(g!="originalObj"&&!a[g].childNodes&&!a[g].parentNode&&(c(a[g])||!(!a[g]instanceof Array)))if(f=d.indexOf(a[g]),f!=-1)b[g]=e[f];else{if(!b[g])b[g]=a[g]instanceof Array?[]:{},b[g].originalObj=a[g];d.push(a[g]);e.push(b[g]);b[g]=this.copyAttributesRec(a[g],b[g],c,d,e)}}else b[g]=a[g];return b},len:function(a){var b=0,c;for(c in a)b++;return b},restoreAttributes:function(a,b){this.cleanAttributesRec(a,b,[]);this.restoreAttributesRec(b,[]);this.cleanAttributesRec(a,
b,[])},cleanAttributesRec:function(a,b,c){if(typeof a!="object")return!1;for(var d in a)typeof a[d]=="object"&&d!="originalObj"&&(typeof b[d]=="undefined"?a instanceof Array&&a[d].doUndo&&(a.splice(d,1),d++):c.indexOf(a[d])==-1&&(c.push(a[d]),this.cleanAttributesRec(a[d],b[d],c)))},restoreAttributesRec:function(a,b){if(typeof a=="undefined")return!1;var c,d;for(d in a)if(d!="originalObj"&&!(typeof a[d]=="undefined"||typeof a[d]=="function")&&!a[d].childNodes&&!a[d].parentNode)if(typeof a[d]=="object"){if(c=
b.indexOf(a[d]),c==-1){b.push(a[d]);a[d].originalObj||console.log("lib_objs.restoreAttributesRec : warning");if(a.originalObj instanceof Array)if(c=a.originalObj.indexOf(a[d].originalObj),c==-1)a.originalObj.splice(d,0,a[d].originalObj),console.log("sds",d,c);else{a.originalObj[d]=a[d].originalObj;a[d].doUndo2||this.restoreAttributesRec(a[d],b);continue}this.restoreAttributesRec(a[d],b)}}else typeof a.originalObj!="undefined"&&(a.originalObj[d]=a[d]);a.originalObj&&a.originalObj.endRestore&&a.originalObj.endRestore(a);
return!0}},lib_ajax={get:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0);c.onreadystatechange=function(){c.readyState==4&&c.status==200&&b(c.responseText)};c.send()}},lib_array={mapMethod:function(a,b){for(var c=0;c<a.length;c++)a[c][b]()},mapMethod1Arg:function(a,b,c){for(var d=0;d<a.length;d++)a[d][b](c)},mapMethod2Args:function(a,b,c,d){for(var e=0;e<a.length;e++)a[e][b](c,d)},mapFunc:function(a,b){for(var c=0;c<a.length;c++)b(a[c])},delIndices:function(a,b){b.sort();for(var c=0,d=0;d<
b.length;d++)a.splice(b[d]-c,1),c++},checkIfDifferents:function(a){for(var b=0;b<a.length;b++)for(var c=b+1;c<a.length;c++)if(a[b]==a[c])return!1;return!0},removeElement:function(a,b){var c=a.indexOf(b);if(c==-1)return!1;a.splice(c,1);return!0},replaceElement:function(a,b,c){var d=a.indexOf(b);if(d==-1)return!1;a.splice(d,1,c);if(!this.replaceElement(a,b,c))return!0},searchAttribute:function(a,b){for(var c=0;c<a.length;c++)if(a[c][b])return a[c];return!1},parseFloat:function(a){for(var b=0;b<a.length;b++)a[b]=
parseFloat(a[b])},pushOnce:function(a,b){if(a.indexOf(b)!=-1)return!1;a.push(b);return!0},copy:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},copy2:function(a){for(var b=[],c=0;c<a.length;c++)b.push(this.copy(a[c]));return b},flatten:function(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}},lib_vector={affect:function(a,b){a[0]=b[0];a[1]=b[1]},middle:function(a,b){return[(a[0]+b[0])*0.5,(a[1]+b[1])*0.5]},norm2:function(a){return a[0]*a[0]+a[1]*a[1]},norm:function(a){return Math.sqrt(this.norm2(a))},
sub:function(a,b){a[0]-=b[0];a[1]-=b[1]},subNew:function(a,b){return[a[0]-b[0],a[1]-b[1]]},add:function(a,b){a[0]+=b[0];a[1]+=b[1]},addHalfNew:function(a,b){return[a[0]+0.5*b[0],a[1]+0.5*b[1]]},addNew:function(a,b){return[a[0]+b[0],a[1]+b[1]]},scaleNew:function(a,b){return[a[0]*b,a[1]*b]},scale:function(a,b){a[0]*=b;a[1]*=b},madd:function(a,b,c,d){return[c*a[0]+d*b[0],c*a[1]+d*b[1]]},copy:function(a){return[a[0],a[1]]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]},det:function(a,b){return a[0]*b[1]-
a[1]*b[0]},invert:function(a){a[0]*=-1;a[1]*=-1},invertNew:function(a){return[-a[0],-a[1]]},angleFromX:function(a){return Math.atan2(a[1],a[0])},angleFromY:function(a){return Math.atan2(a[0],a[1])},scaleXY:function(a,b){return[a[0]*b[0],a[1]*b[1]]},divideXY:function(a,b){a[0]/=b[0];a[1]/=b[1]},mixNew:function(a,b,c){return[a[0]*c+b[0]*(1-c),a[1]*c+b[1]*(1-c)]},halfNew:function(a){return[a[0]*0.5,a[1]*0.5]},fmaNew:function(a,b,c){return[a[0]*c+b[0],a[1]*c+b[1]]},get3D:function(a){return[a[0],a[1],
0]},rotateHalfPi:function(a){var b=a[0];a[0]=a[1];a[1]=b},get_unit:function(a,b){var c=this.subNew(b,a);this.normalize(c);return c},addN:function(){for(var a=arguments[0],b=1;b<arguments.length;b++)a[0]+=arguments[b][0],a[1]+=arguments[b][1]},addNNew:function(){for(var a=[arguments[0][0],arguments[0][1]],b=1;b<arguments.length;b++)a[0]+=arguments[b][0],a[1]+=arguments[b][1];return a},rotateNew:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=[];e[0]=c*a[0]+d*a[1];e[1]=-d*a[0]+c*a[1];return e},rotate:function(a,
b){var c=Math.cos(b),d=Math.sin(b),e=a[0];a[0]=c*a[0]+d*a[1];a[1]=-d*e+c*a[1]},rotatePointNew:function(a,b,c){a=this.subNew(a,b);a=this.rotateNew(a,c);return this.addNew(a,b)},rotatePoint:function(a,b,c){a=this.subNew(a,b);a=this.rotateNew(a,c);this.addNew(a,b)},normalize:function(a){var b=1/this.norm(a);a[0]*=b;a[1]*=b},normalizeNew:function(a){var b=1/this.norm(a);return[a[0]*b,a[1]*b]},normal:function(a){var b=1/Math.sqrt(this.norm2(a));return[a[0]*b,a[1]*b]},proj:function(a,b){var c=this.dot(a,
b);return[b[0]*c,b[1]*c]},angle:function(a,b){var c=this.dot(a,b),d=this.det(a,b);return Math.atan2(d,c)},angleGen:function(a,b){var c=this.norm(a)*this.norm(b),d=this.dot(a,b)/c,c=this.det(a,b)/c;return Math.atan2(c,d)},distance:function(a,b){return this.norm(this.subNew(a,b))},distance2:function(a,b){return this.norm2(this.subNew(a,b))},distPtSeg:function(a,b,c){var d=this.norm2(this.subNew(c,b)),d=((a[0]-b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return this.distance([b[0]+d*(c[0]-b[0]),b[1]+
d*(c[1]-b[1])],a)},distPtSegInside:function(a,b,c){var d=this.norm2(this.subNew(c,b)),d=((a[0]-b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return d<0||d>1?9999999999:this.distance([b[0]+d*(c[0]-b[0]),b[1]+d*(c[1]-b[1])],a)},distSegSegInside:function(a,b,c,d){c=this.distPtSegInside(c,a,b);if(!c)return!1;a=this.distPtSegInside(d,a,b);return!a?!1:0.5*(c+a)},getPerp:function(a){a=[a[1],-a[0]];this.normalize(a);return a},projSeg:function(a,b,c){var d=this.norm2(this.subNew(c,b)),a=((a[0]-b[0])*(c[0]-
b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return[b[0]+a*(c[0]-b[0]),b[1]+a*(c[1]-b[1])]},projLine:function(a,b,c){a=(a[0]-b[0])*c[0]+(a[1]-b[1])*c[1];return[b[0]+a*c[0],b[1]+a*c[1]]},projSegInside:function(a,b,c){var d=this.norm2(this.subNew(c,b)),a=((a[0]-b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1]))/d;return a<0||a>1?!1:[b[0]+a*(c[0]-b[0]),b[1]+a*(c[1]-b[1])]},buildFromAngle:function(a,b){return[Math.cos(a)*b,Math.sin(a)*b]},getAnglePoints:function(a,b,c){b=lib_vector.subNew(b,a);a=lib_vector.subNew(c,a);return Math.atan2(this.det(b,
a),this.dot(b,a))},bissect:function(a,b,c){var a=lib_vector.subNew(b,a),b=lib_vector.subNew(b,c),c=this.norm(a),d=this.norm(b),a=lib_vector.madd(a,b,d,c);lib_vector.normalize(a);return a},intersectSegLine:function(a,b,c,d){a=lib_vector.subNew(a,c);b=lib_vector.subNew(b,c);return this.dot(a,d)<0&&this.dot(b,d)<0?!1:this.det(a,d)*this.det(b,d)<0?!0:!1},intersectSegSeg:function(a,b,c,d){var e=this.subNew(c,a),f=this.subNew(d,a),a=this.subNew(b,a);if(this.det(a,e)*this.det(a,f)>=0)return!1;this.invert(e);
b=this.subNew(b,c);c=this.subNew(d,c);return this.det(c,e)*this.det(c,b)>=0?!1:!0},intersectLineLine:function(a,b,c,d){var e=this.det(b,d);if(e==0)return!1;var f=this.det(a,d),c=(this.det(c,d)-f)/e;return this.addNew(a,this.scaleNew(b,c))},intersectSegSegInside:function(a,b,c,d){var b=this.subNew(b,a),d=this.subNew(d,c),e=this.subNew(a,c),c=this.subNew(c,a),c=this.det(b,c),f=this.det(b,d),d=this.det(d,e);if(f==0)return!1;d/=f;e=-c/f;if(d<0||d>1)return!1;if(e<0||e>1)return!1;this.scale(b,d);return lib_vector.addNew(a,
b)},angleSegFromX:function(a,b){return this.angleFromX(this.subNew(b,a))}},lib_form={prompt:function(a,b){return prompt(a||"Valeur: ",b||"0")},alert:function(a){alert(a)},confirm:function(a){return confirm(a)}},lib_dom={removeElement:function(a){a=document.getElementById(a);a.parentNode.removeChild(a)},show:function(a){document.getElementById(a).style.display="block"},hide:function(a){document.getElementById(a).style.display="none"},hideShow:function(a){a=document.getElementById(a);a.style.display==
"block"?this.hideElement(a):this.showElement(a)},get:function(a){return document.getElementById(a)},getValue:function(a){return document.getElementById(a).value},showElement:function(a){a.style.display="block"},hideElement:function(a){a.style.display="none"},translate:function(a,b,c){var d=this.getPos(this.get(a));this.setPos(a,d[0]+b,d[1]+c)},get_top:function(a){return parseInt(this.get(a).style.top)},get_left:function(a){return parseInt(this.get(a).style.left)},getPos:function(a){for(var b=[0,0];a!=
null;)b[1]+=a.offsetTop,b[0]+=a.offsetLeft,a=a.offsetParent;return b},setPos:function(a,b,c){this.setPosElt(this.get(a),b,c)},setMarginsElt:function(a,b,c){a.style.marginLeft=Math.round(b)+"px";a.style.marginTop=Math.round(c)+"px"},getMarginsElt:function(a){return parseFloat(a.style.marginLeft,a.style.marginTop)},setPosElt:function(a,b,c){a.style.left=Math.round(b)+"px";a.style.top=Math.round(c)+"px"},setClass:function(a,b){a.setAttribute("class",b)},set_front:function(a){ZINDEXFRONT++;this.get(a).style.zIndex=
ZINDEXFRONT},transformMatrix:function(a,b,c){var d=Math.cos(b),b=Math.sin(b),c="matrix("+d+","+-b+","+b+","+d+","+c[0]+","+c[1]+")";a.style.transform=c;a.style.MozTransform=c},rotate:function(a,b){var c=lib_maths.round(lib_maths.radToDeg(b),2);a.style.MozTransform="rotate("+c+"deg)";a.style.WebkitTransform="rotate("+c+"deg)";a.style.transform="rotate("+c+"deg)"}},ZINDEXFRONT=100,lib_colors={parse:function(a){a=a.replace("rgb(","").replace(")","").replace("rgba(","").split(",");lib_array.parseFloat(a);
a.length==3&&a.push(1);return a},toString:function(a){return"rgba("+a[0]+","+a[1]+","+a[2]+","+a[3]+")"},lighten:function(a,b){for(var c=this.parse(a),d=this.rgb_to_rgb01(c.slice(0,3)),d=this.rgb01_to_tsv(d),e=0;e<3;e++)d[e]=Math.min(1,d[e]+b[e]/255);d=this.rgb01_to_rgb(this.tsv_to_rgb01(d));c.length==4&&d.push(c[3]);return this.toString(d)},lighten2:function(a,b){for(var c=this.parse(a),d=this.rgb_to_rgb01(c.slice(0,3)),d=this.rgb01_to_tsv(d),e=0;e<3;e++)d[e]=lib_maths.clamp(d[e]*b[e]+b[3]*(b[e]-
1),0,1);d=this.rgb01_to_rgb(this.tsv_to_rgb01(d));c.length==4&&d.push(lib_maths.clamp(c[3]+b[4],0,1));return this.toString(d)},rgb_to_rgb01:function(a){return[a[0]/255,a[1]/255,a[2]/255]},rgb01_to_rgb:function(a){return[Math.round(a[0]*255),Math.round(a[1]*255),Math.round(a[2]*255)]},tsv_to_rgb01:function(a){var b=a[0]*360,c=a[1],a=a[2],d=Math.floor(b/60)%6,e=b/60-d,b=a*(1-c),f=a*(1-e*c),c=a*(1-(1-e)*c);switch(d){case 0:return[a,c,b];case 1:return[f,a,b];case 2:return[b,a,c];case 3:return[b,f,a];
case 4:return[c,b,a];case 5:return[a,b,f]}},rgb01_to_tsv:function(a){var b=a[0],c=a[1],a=a[2],d=Math.max(b,c,a),e=Math.min(b,c,a),f;switch(d){case e:f=0;break;case b:f=(60*(c-a)/(d-e)+360)%360;break;case c:f=60*(a-b)/(d-e)+120;break;case a:f=60*(b-c)/(d-e)+240}return[f/360,d==0?0:1-e/d,d]},floatToRgb:function(a){return"#"+Math.round(a*16777216).toString(16)}},lib_matrix_base={invertNew:function(a,b){var c=this.buildINew(b),d=this.copyNew(a),e,f,g,i;for(e=0;e<b;e++){if(d[e*b+e]==0)for(f=e;f<b;f++)if(d[f*
b+e]!=0){for(g=0;g<b;g++)i=d[e*b+g],d[e*b+g]=d[f*b+g],d[f*b+g]=i,i=c[e*b+g],c[e*b+g]=c[f*b+g],c[f*b+g]=i;break}i=d[e*b+e];for(g=0;g<b;g++)d[e*b+g]/=i,c[e*b+g]/=i;for(f=0;f<b;f++)if(f!=e){i=d[f*b+e];for(g=0;g<b;g++)d[f*b+g]-=i*d[e*b+g],c[f*b+g]-=i*c[e*b+g]}}return c},mix:function(a,b,c){for(var d=Array(a.length),e=0;e<16;++e)d[e]=c*a[e]+(1-c)*b[e];return d},copyNew:function(a){for(var b=Array(a.length),c=0;c<a.length;c++)b[c]=a[c];return b},buildINew:function(a){for(var b=[],c=0;c<a;c++)for(var d=
0;d<a;d++)c==d?b.push(1):b.push(0);return b}},lib_matrix_base3={get_I3:function(){return[1,0,0,0,1,0,0,0,1]},multNew:function(a,b){return[a[0]*b[0]+a[1]*b[3]+a[2]*b[6],a[0]*b[1]+a[1]*b[4]+a[2]*b[7],a[0]*b[2]+a[1]*b[5]+a[2]*b[8],a[3]*b[0]+a[4]*b[3]+a[5]*b[6],a[3]*b[1]+a[4]*b[4]+a[5]*b[7],a[3]*b[2]+a[4]*b[5]+a[5]*b[8],a[6]*b[0]+a[7]*b[3]+a[8]*b[6],a[6]*b[1]+a[7]*b[4]+a[8]*b[7],a[6]*b[2]+a[7]*b[5]+a[8]*b[8]]},multArrayNew:function(a,b,c){var d,e;e=[];for(d=0;d<c*9;d+=9)e.push(a[d]*b[d]+a[d+1]*b[d+3]+
a[d+2]*b[d+6],a[d]*b[d+1]+a[d+1]*b[d+4]+a[d+2]*b[d+7],a[d]*b[d+2]+a[d+1]*b[d+5]+a[d+2]*b[d+8],a[d+3]*b[d]+a[d+4]*b[d+3]+a[d+5]*b[d+6],a[d+3]*b[d+1]+a[d+4]*b[d+4]+a[d+5]*b[d+7],a[d+3]*b[d+2]+a[d+4]*b[d+5]+a[d+5]*b[d+8],a[d+6]*b[d]+a[d+7]*b[d+3]+a[d+8]*b[d+6],a[d+6]*b[d+1]+a[d+7]*b[d+4]+a[d+8]*b[d+7],a[d+6]*b[d+2]+a[d+7]*b[d+5]+a[d+8]*b[d+8]);return e},buildFromVect:function(a,b,c){return a.concat(b).concat(c)},multVectNew:function(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[3]*b[0]+a[4]*b[1]+a[5]*
b[2],a[6]*b[0]+a[7]*b[1]+a[8]*b[2]]},transposeNew:function(a){return[a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]]}},lib_matrix_base4={multNew:function(a,b){return[a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12],a[0]*b[1]+a[1]*b[5]+a[2]*b[9]+a[3]*b[13],a[0]*b[2]+a[1]*b[6]+a[2]*b[10]+a[3]*b[14],a[0]*b[3]+a[1]*b[7]+a[2]*b[11]+a[3]*b[15],a[4]*b[0]+a[5]*b[4]+a[6]*b[8]+a[7]*b[12],a[4]*b[1]+a[5]*b[5]+a[6]*b[9]+a[7]*b[13],a[4]*b[2]+a[5]*b[6]+a[6]*b[10]+a[7]*b[14],a[4]*b[3]+a[5]*b[7]+a[6]*b[11]+a[7]*b[15],a[8]*
b[0]+a[9]*b[4]+a[10]*b[8]+a[11]*b[12],a[8]*b[1]+a[9]*b[5]+a[10]*b[9]+a[11]*b[13],a[8]*b[2]+a[9]*b[6]+a[10]*b[10]+a[11]*b[14],a[8]*b[3]+a[9]*b[7]+a[10]*b[11]+a[11]*b[15],a[12]*b[0]+a[13]*b[4]+a[14]*b[8]+a[15]*b[12],a[12]*b[1]+a[13]*b[5]+a[14]*b[9]+a[15]*b[13],a[12]*b[2]+a[13]*b[6]+a[14]*b[10]+a[15]*b[14],a[12]*b[3]+a[13]*b[7]+a[14]*b[11]+a[15]*b[15]]},copyNew:function(a){return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]},to3New:function(a){return[a[0],a[1],
a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},to3TNew:function(a){return[a[0],a[4],a[8],a[1],a[5],a[9],a[2],a[6],a[10]]},transposeNew:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},getI4:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},setI4:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},copy:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=
a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15]}},lib_matrix_mv={distance:function(a,b){return Math.sqrt((a[12]-b[12])*(a[12]-b[12])+(a[13]-b[13])*(a[13]-b[13])+(a[14]-b[14])*(a[14]-b[14]))},applyRot:function(a,b,c){var d=lib_matrix_getDepl(c),c=lib_matrix_4_to_3(c),c=lib_matrix_multMatrix3(c,lib_matrix_rotMatrix(a,b));return lib_matrix_buildMvMatrix(c,d)},applyMRotNew:function(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[4]*b[0]+
a[5]*b[1]+a[6]*b[2],a[8]*b[0]+a[9]*b[1]+a[10]*b[2]]},transNew:function(a,b){return[b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],b[12]+a[0],b[13]+a[1],b[14]+a[2],b[15]]},buildNew:function(a,b){return[a[0],a[1],a[2],b[0],a[3],a[4],a[5],b[1],a[6],a[7],a[8],b[2],b[0],b[1],b[2],1]},getDepl:function(a){return[a[12],a[13],a[14]]},translate:function(a,b){a[12]+=b[0];a[13]+=b[1];a[14]+=b[2]},setPos:function(a,b){a[12]=b[0];a[13]=b[1];a[14]=b[2]},translateRot:function(a,b){a[12]+=b[0]*a[0]+
b[1]*a[4]+b[2]*a[8];a[13]+=b[0]*a[1]+b[1]*a[5]+b[2]*a[9];a[14]+=b[0]*a[2]+b[1]*a[6]+b[2]*a[10]},combine:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[4],g=a[5],i=a[6],k=a[8],h=a[9];a[12]+=a[0]*b[12]+a[4]*b[13]+a[8]*b[14];a[13]+=a[1]*b[12]+a[5]*b[13]+a[9]*b[14];a[14]+=a[2]*b[12]+a[6]*b[13]+a[10]*b[14];a[0]=c*b[0]+f*b[1]+k*b[2];a[1]=d*b[0]+g*b[1]+h*b[2];a[2]=e*b[0]+i*b[1]+a[10]*b[2];a[4]=c*b[4]+f*b[5]+k*b[6];a[5]=d*b[4]+g*b[5]+h*b[6];a[6]=e*b[4]+i*b[5]+a[10]*b[6];a[8]=c*b[8]+f*b[9]+k*b[10];a[9]=d*b[8]+
g*b[9]+h*b[10];a[10]=e*b[8]+i*b[9]+a[10]*b[10]},combineNew:function(a,b){return[a[0]*b[0]+a[4]*b[1]+a[8]*b[2],a[1]*b[0]+a[5]*b[1]+a[9]*b[2],a[2]*b[0]+a[6]*b[1]+a[10]*b[2],a[3]*b[0]+a[7]*b[1]+a[11]*b[2],a[0]*b[4]+a[4]*b[5]+a[8]*b[6],a[1]*b[4]+a[5]*b[5]+a[9]*b[6],a[2]*b[4]+a[6]*b[5]+a[10]*b[6],a[3]*b[4]+a[7]*b[5]+a[11]*b[6],a[0]*b[8]+a[4]*b[9]+a[8]*b[10],a[1]*b[8]+a[5]*b[9]+a[9]*b[10],a[2]*b[8]+a[6]*b[9]+a[10]*b[10],a[3]*b[8]+a[7]*b[9]+a[11]*b[10],a[12]+a[0]*b[12]+a[4]*b[13]+a[8]*b[14],a[13]+a[1]*b[12]+
a[5]*b[13]+a[9]*b[14],a[14]+a[2]*b[12]+a[6]*b[13]+a[10]*b[14],1]},combineT:function(a,b,c){var d=a[0],e=a[1],f=a[4],g=a[5],i=a[8],k=a[9],h=1-c;a[12]+=h*(a[0]*b[12]+a[4]*b[13]+a[8]*b[14]);a[13]+=h*(a[1]*b[12]+a[5]*b[13]+a[9]*b[14]);a[14]+=h*(a[2]*b[12]+a[6]*b[13]+a[10]*b[14]);a[0]=d*(b[0]*h+c)+e*b[4]*h+a[2]*b[8]*h;a[1]=d*b[1]*h+e*(b[5]*h+c)+a[2]*b[9]*h;a[2]=d*b[2]*h+e*b[6]*h+a[2]*(b[10]*h+c);a[4]=f*(b[0]*h+c)+g*b[4]*h+a[6]*b[8]*h;a[5]=f*b[1]*h+g*(b[5]*h+c)+a[6]*b[9]*h;a[6]=f*b[2]*h+g*b[6]*h+a[6]*(b[10]*
h+c);a[8]=i*(b[0]*h+c)+k*b[4]*h+a[10]*b[8]*h;a[9]=i*b[1]*h+k*(b[5]*h+c)+a[10]*b[9]*h;a[10]=i*b[2]*h+k*b[6]*h+a[10]*(b[10]*h+c)},combineT2:function(a,b,c,d){var e=a[0],f=a[1],g=a[4],i=a[5],k=a[8],h=a[9],j=1-d;a[12]+=j*(a[0]*b[12]+a[4]*b[13]+a[8]*b[14])+d*(a[0]*c[12]+a[4]*c[13]+a[8]*c[14]);a[13]+=j*(a[1]*b[12]+a[5]*b[13]+a[9]*b[14])+d*(a[1]*c[12]+a[5]*c[13]+a[9]*c[14]);a[14]+=j*(a[2]*b[12]+a[6]*b[13]+a[10]*b[14])+d*(a[2]*c[12]+a[6]*c[13]+a[10]*c[14]);a[0]=e*(b[0]*j+d*c[0])+f*(b[4]*j+d*c[4])+a[2]*(b[8]*
j+d*c[8]);a[1]=e*(b[1]*j+d*c[1])+f*(b[5]*j+d*c[5])+a[2]*(b[9]*j+d*c[9]);a[2]=e*(b[2]*j+d*c[2])+f*(b[6]*j+d*c[6])+a[2]*(b[10]*j+d*c[10]);a[4]=g*(b[0]*j+d*c[0])+i*(b[4]*j+d*c[4])+a[6]*(b[8]*j+d*c[8]);a[5]=g*(b[1]*j+d*c[1])+i*(b[5]*j+d*c[5])+a[6]*(b[9]*j+d*c[9]);a[6]=g*(b[2]*j+d*c[2])+i*(b[6]*j+d*c[6])+a[6]*(b[10]*j+d*c[10]);a[8]=k*(b[0]*j+d*c[0])+h*(b[4]*j+d*c[4])+a[10]*(b[8]*j+d*c[8]);a[9]=k*(b[1]*j+d*c[1])+h*(b[5]*j+d*c[5])+a[10]*(b[9]*j+d*c[9]);a[10]=k*(b[2]*j+d*c[2])+h*(b[6]*j+d*c[6])+a[10]*(b[10]*
j+d*c[10])},combineT22:function(a,b,c,d){var e=a[0],f=a[1],g=a[4],i=a[5],k=a[8],h=a[9],j=1-d;a[12]+=j*(a[0]*b[12]+a[4]*b[13]+a[8]*b[14])+d*(a[0]*c[12]+a[4]*c[13]+a[8]*c[14]);a[13]+=j*(a[1]*b[12]+a[5]*b[13]+a[9]*b[14])+d*(a[1]*c[12]+a[5]*c[13]+a[9]*c[14]);a[14]+=j*(a[2]*b[12]+a[6]*b[13]+a[10]*b[14])+d*(a[2]*c[12]+a[6]*c[13]+a[10]*c[14]);a[0]=e*(b[0]*j+d*c[0])+f*(b[4]*j+d*c[4])+a[2]*(b[8]*j+d*c[8]);a[1]=e*(b[1]*j+d*c[1])+f*(b[5]*j+d*c[5])+a[2]*(b[9]*j+d*c[9]);a[2]=e*(b[2]*j+d*c[2])+f*(b[6]*j+d*c[6])+
a[2]*(b[10]*j+d*c[10]);a[4]=g*(b[0]*j+d*c[0])+i*(b[4]*j+d*c[4])+a[6]*(b[8]*j+d*c[8]);a[5]=g*(b[1]*j+d*c[1])+i*(b[5]*j+d*c[5])+a[6]*(b[9]*j+d*c[9]);a[6]=g*(b[2]*j+d*c[2])+i*(b[6]*j+d*c[6])+a[6]*(b[10]*j+d*c[10]);a[8]=k*(b[0]*j+d*c[0])+h*(b[4]*j+d*c[4])+a[10]*(b[8]*j+d*c[8]);a[9]=k*(b[1]*j+d*c[1])+h*(b[5]*j+d*c[5])+a[10]*(b[9]*j+d*c[9]);a[10]=k*(b[2]*j+d*c[2])+h*(b[6]*j+d*c[6])+a[10]*(b[10]*j+d*c[10])},invert:function(a,b){a[0]=b[0];a[1]=b[4];a[2]=b[8];a[4]=b[1];a[5]=b[5];a[6]=b[9];a[8]=b[2];a[9]=b[6];
a[10]=b[10];a[12]=-(b[0]*b[12]+b[1]*b[13]+b[2]*b[14]);a[13]=-(b[4]*b[12]+b[5]*b[13]+b[6]*b[14]);a[14]=-(b[8]*b[12]+b[9]*b[13]+b[10]*b[14])},invertNew:function(a){var b=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.invert(b,a);return b},moveOrigin:function(a,b,c){c[0]=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]-a[12]*a[0]-a[13]*a[1]-a[14]*a[2];c[1]=a[4]*b[0]+a[5]*b[1]+a[6]*b[2]-a[12]*a[4]-a[13]*a[5]-a[14]*a[6];c[2]=a[8]*b[0]+a[9]*b[1]+a[10]*b[2]-a[12]*a[8]-a[13]*a[9]-a[14]*a[10]},moveDirection:function(a,b,c){c[0]=a[0]*
b[0]+a[1]*b[1]+a[2]*b[2];c[1]=a[4]*b[0]+a[5]*b[1]+a[6]*b[2];c[2]=a[8]*b[0]+a[9]*b[1]+a[10]*b[2]},getInvertDepl:function(a,b){b[0]=-(a[0]*a[12]+a[1]*a[13]+a[2]*a[14]);b[1]=-(a[4]*a[12]+a[5]*a[13]+a[6]*a[14]);b[2]=-(a[8]*a[12]+a[9]*a[13]+a[10]*a[14])},multVectorTransNew:function(a,b){return[a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12],a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13],a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]]},multVectorNew:function(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3],a[4]*b[0]+a[5]*b[1]+a[6]*b[2]+
a[7],a[8]*b[0]+a[9]*b[1]+a[10]*b[2]+a[11]]},invX:function(a){a[0]*=-1;a[4]*=-1;a[8]*=-1;a[12]*=-1},buildFrom2DWall:function(a,b,c){var d=lib_matrix_base4.copyNew(Matrix.I4);lib_matrix_rot.rotateXFast(d,b);lib_matrix_rot.rotateZFast(d,a);this.setPos(d,c);this.invX(d);return d},buildFrom2DFloor:function(){return[-1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1]},picking_dirRefScene:function(a,b){var c=b[0],d=b[1];b[0]=a[0]*c+a[1]*d+a[2]*b[2];b[1]=a[4]*c+a[5]*d+a[6]*b[2];b[2]=a[8]*c+a[9]*d+a[10]*b[2]},invertX:function(a){a[0]*=
-1;a[4]*=-1;a[8]*=-1},invertY:function(a){a[1]*=-1;a[5]*=-1;a[9]*=-1}},lib_matrix_proj={makePerspectiveNew:function(a,b,c,d){var a=c*Math.tan(a*Math.PI/360),e=-a;return this.makeFrustumNew(e*b,a*b,e,a,c,d)},makeFrustumNew:function(a,b,c,d,e,f){return[2*e/(b-a),0,0,0,0,2*e/(d-c),0,0,(b+a)/(b-a),(d+c)/(d-c),-(f+e)/(f-e),-1,0,0,-2*f*e/(f-e),0]}},lib_matrix_rot={rotateXFast:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[1],f=a[5],g=a[9];a[1]=a[1]*c-a[2]*d;a[5]=a[5]*c-a[6]*d;a[9]=a[9]*c-a[10]*d;a[2]=
a[2]*c+e*d;a[6]=a[6]*c+f*d;a[10]=a[10]*c+g*d},rotateYFast:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[0],f=a[4],g=a[8];a[0]=c*a[0]+d*a[2];a[4]=c*a[4]+d*a[6];a[8]=c*a[8]+d*a[10];a[2]=c*a[2]-d*e;a[6]=c*a[6]-d*f;a[10]=c*a[10]-d*g},rotateZFast:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[0],f=a[4],g=a[8];a[0]=c*a[0]-d*a[1];a[4]=c*a[4]-d*a[5];a[8]=c*a[8]-d*a[9];a[1]=c*a[1]+d*e;a[5]=c*a[5]+d*f;a[9]=c*a[9]+d*g},rotNew:function(a,b){var c=Math.cos(a),d=Math.sin(a),e=1-c;return[c+e*b[0]*b[0],e*
b[0]*b[1]-d*b[2],e*b[0]*b[2]+d*b[1],e*b[0]*b[1]+b[2]*d,c+e*b[1]*b[1],e*b[1]*b[2]-d*b[0],e*b[0]*b[2]-d*b[1],e*b[1]*b[2]+d*b[0],c+e*b[2]*b[2]]},rotTransY:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[0],f=a[4],g=a[8],i=a[12];a[12]=i*c+d*a[14];a[14]=-d*i+c*a[14];a[0]=c*a[0]+d*a[2];a[4]=c*a[4]+d*a[6];a[8]=c*a[8]+d*a[10];a[2]=c*a[2]-d*e;a[6]=c*a[6]-d*f;a[10]=c*a[10]-d*g},rotTransX:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[1],f=a[5],g=a[9],i=a[13];a[13]=i*c+d*a[14];a[14]=-d*i+c*a[14];a[1]=c*
a[1]+d*a[2];a[5]=c*a[5]+d*a[6];a[9]=c*a[9]+d*a[10];a[2]=c*a[2]-d*e;a[6]=c*a[6]-d*f;a[10]=c*a[10]-d*g}},lib_vector3D={norm2:function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},norm:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},vnew:function(a){return[a[0],a[1],a[2]]},scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b},subNew:function(a,b){return[b[0]-a[0],b[1]-a[1],b[2]-a[2]]},maddNew:function(a,b,c){return[a[0]+c*b[0],a[1]+c*b[1],a[2]+c*b[2]]},mixNew:function(a,b,c){return[a[0]*c+b[0]*(1-c),
a[1]*c+b[1]*(1-c),a[2]*c+b[2]*(1-c)]},baryNew:function(a,b,c,d){return[a[0]*c+b[0]*d,a[1]*c+b[1]*d,a[2]*c+b[2]*d]},copy:function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},det:function(a,b,c){return a[0]*(b[1]*c[2]-b[2]*c[1])-a[1]*(b[0]*c[2]-b[2]*c[0])+a[2]*(b[0]*c[1]-b[1]*c[0])},prodNew:function(a,b){return[a*b[0],a*b[1],a*b[2]]},add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]},addNew:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},make2D:function(a){return[a[0],
a[1]]},middleNew:function(a,b){return[(a[0]+b[0])*0.5,(a[1]+b[1])*0.5,(a[2]+b[2])*0.5]},normalize:function(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]*=b;a[1]*=b;a[2]*=b},normalizeNew:function(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]*b,a[1]*b,a[2]*b]},distance2:function(a,b){return(b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1])+(b[2]-a[2])*(b[2]-a[2])},distance:function(a,b){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1])+(b[2]-a[2])*(b[2]-a[2]))},
distance2Sub:function(a,b){return(b[0]+a[0])*(b[0]+a[0])+(b[1]+a[1])*(b[1]+a[1])+(b[2]+a[2])*(b[2]+a[2])},distanceSub:function(a,b){return Math.sqrt((b[0]+a[0])*(b[0]+a[0])+(b[1]+a[1])*(b[1]+a[1])+(b[2]+a[2])*(b[2]+a[2]))},prodVectNew:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},move:function(a,b){var c=a[0],d=a[1];a[0]=c*b[0]+d*b[1]+a[2]*b[2]+b[12];a[1]=c*b[4]+d*b[5]+a[2]*b[6]+b[13];a[2]=c*b[8]+d*b[9]+a[2]*b[10]+b[14]},getNormalNew:function(a,b){var c=this.prodVectNew(a,
b);this.normalize(c);return c},getUVCoeff:function(a,b){var c=lib_vector_sub(b[1],b[0]),d=lib_vector_sub(b[2],b[0]),e=lib_vector_sub(a,b[0]),f=lib_vector_dot(e,c),e=lib_vector_dot(e,d),g=lib_vector_dot(c,d),c=lib_vector_dot(c,c),d=lib_vector_dot(d,d);return[(e*g-f*d)/(g*g-c*d),(f*g-e*c)/(g*g-c*d)]},rotateZ:function(a,b){var c=[0,0];c[0]=Math.cos(b)*a[0]+Math.sin(b)*a[1];c[1]=-Math.sin(b)*a[0]+Math.cos(b)*a[1];c[2]=a[2];return c},distPtSeg:function(a,b,c){var d=this.norm2(this.subNew(c,b)),d=((a[0]-
b[0])*(c[0]-b[0])+(a[1]-b[1])*(c[1]-b[1])+(a[2]-b[2])*(c[2]-b[2]))/d;return{dist:this.distance([b[0]+d*(c[0]-b[0]),b[1]+d*(c[1]-b[1]),b[2]+d*(c[2]-b[2])],a),u:d}},intersectSegPlaneZ0:function(a,b){var c=this.subNew(b,a);if(c[2]==0)return!1;var d=-a[2]/c[2];return d>0?!1:d<-1?!1:[a[0]+d*c[0],a[1]+d*c[1],0]},get_angle:function(a,b){return Math.acos(this.dot(a,b)/(this.norm(a)*this.norm(b)))},rotateNew:function(a,b,c){a=lib_matrix_rot.rotNew(a,b);return lib_matrix_base3.multNew(a,c)}},lib_buffersArray=
{concat:function(a,b,c){for(var d=[],e=0;e<a.length/3;e++)d.push(a[e*3],a[e*3+1],a[e*3+2],b[e*3],b[e*3+1],b[e*3+2],c[e*2],c[e*2+1]);return d},concato:function(a,b,c,d){for(var e=[],f=0;f<a.length/3;f++)e.push(a[f*3],a[f*3+1],a[f*3+2],b[f*3],b[f*3+1],b[f*3+2],c[f*2],c[f*2+1],d[f*2],d[f*2+1]);return e},sort:function(a,b,c,d){d=d||8;lib_buffersArray.quickSort(a,b,c,0,Math.floor(a.length/d)-1,d)},quickSort:function(a,b,c,d,e,f){f=f||8;if(d<e){var g;g=lib_buffersArray.part(a,b,c,d,e,d,f);lib_buffersArray.quickSort(a,
b,c,d,g-1,f);lib_buffersArray.quickSort(a,b,c,g+1,e,f)}},part:function(a,b,c,d,e,f,g){g=g||8;lib_buffersArray.swap(a,b,f,e,g);for(f=d;d<e;++d){var i=g*d,k=e*g;c(a[i],a[i+1],a[i+2],a[k],a[k+1],a[k+2])&&(lib_buffersArray.swap(a,b,d,f,g),++f)}lib_buffersArray.swap(a,b,e,f,g);return f},swap:function(a,b,c,d,e){var f;f=b[c];b[c]=b[d];b[d]=f;b=e*c;c=e*d;for(f=0;f<e;++f,++b,++c)d=a[b],a[b]=a[c],a[c]=d},less:function(a,b,c,d,e,f){return a<d||a===d&&b<e||a===d&&b===e&&c<f},equal:function(a,b,c,d,e,f,g){return Math.abs(a-
d)>g?!1:Math.abs(b-e)>g?!1:Math.abs(c-f)>g?!1:!0},tol:1.0E-5,removeDoubles:function(a,b,c,d){lib_buffersArray.sort(a,b,c,d);for(var c=[],e=[],f=b.length,g=0,i=0;g<f-1;++g){var k=d*g,h=k+d;c[b[g]]=i;lib_buffersArray.equal(a[k],a[k+1],a[k+2],a[h],a[h+1],a[h+2],lib_buffersArray.tol)||(e.push(a[k],a[k+1],a[k+2],a[k+3],a[k+4],a[k+5],a[k+6],a[k+7]),i++)}e.push(a[k],a[k+1],a[k+2],a[k+3],a[k+4],a[k+5],a[k+6],a[k+7]);c[b[g]]=i;for(g=0;g<c.length;++g)b[g]=c[g],a[g]=e[g];for(b.splice(g,b.length);g<e.length;++g)a[g]=
e[g];a.splice(g,a.length)}};if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1E3/60)}}();
if(!window.cancelRequestAnimationFrame)window.cancelRequestAnimationFrame=function(){return window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}();
var Shaders=function(){var a={getFragmentShader:function(){var a=GL.createShader(GL.FRAGMENT_SHADER);GL.shaderSource(a,"#ifdef GL_ES\nprecision mediump float;\nprecision mediump vec3;\n#endif\n\nuniform int render, shadow, white;\nuniform sampler2D uSampler0;\nuniform float screenRed;\nuniform vec3 cam_pos;\n\nvarying vec2 vTextureCoord;\nvarying vec3 vNormal, sc_pos;\n\nconst vec3 LIGHT_POS=vec3(0,0,4.);\nconst vec4 ADD_COLOR=vec4(0.1,0.1,0.1,0.);\nconst vec3 BLACK=vec3(0.,0.,0.);\nconst vec3 WHITE=vec3(1.,1.,1.);\nconst vec4 SHADOW_COLOR=vec4(0.0,0.0,0.0,0.5);\n\n\nvoid main(void) {\n     if (shadow==1) {\n        gl_FragColor=SHADOW_COLOR;\n        return;\n     }\n     if (render==1) { //chessman\n        float I;\n        vec3 u=normalize(cam_pos-sc_pos);\n        vec3 l=normalize(LIGHT_POS-sc_pos);\n        if (white==1) {\n            //gl_FragColor=pow(0.6*dot((l-u),vNormal), 32.)*vec4(WHITE,1.); return;\n            I=.4+.4*dot(l, vNormal)+max(0.,dot((l+u),vNormal))+max(0., pow(0.5*dot((l-u),vNormal), 20.));\n        } else {\n            I=.0+.2*max(0., dot(l, vNormal))+max(0., pow(0.5*dot((l-u),vNormal), 20.));\n        }\n        gl_FragColor=I*texture2D(uSampler0,vTextureCoord); gl_FragColor[3]=1.;\n        return;\n     }\n     if (render==3) { //ground\n        float I=.4+.4*dot(normalize(LIGHT_POS-sc_pos), vNormal);\n        I*=1.-smoothstep(0.,30.,length(sc_pos));\n        gl_FragColor=I*texture2D(uSampler0,vTextureCoord); gl_FragColor[3]=1.;\n        return;\n     }\n     if (render==4) { //video screen\n        vec4 color=texture2D(uSampler0,vTextureCoord);\n        float c=0.299*color[0]+0.587*color[1]+0.114*color[2];\n        float a=1.;\n        if (sc_pos[2]<.5) a=smoothstep(0.,.5,sc_pos[2]);\n        if (sc_pos[2]>2.3) a=1.-smoothstep(2.3,2.8,sc_pos[2]);\n        gl_FragColor=vec4(mix(c, .8, screenRed), c, c, a);\n        return;\n     }\n     float I=.3+.5*dot(normalize(LIGHT_POS-sc_pos), vNormal);\n     if (render==2) { //chessboard\n        I+=0.3;\n     }\n     gl_FragColor=I*ADD_COLOR+I*texture2D(uSampler0,vTextureCoord); gl_FragColor[3]=1.; return;\n}\n");GL.compileShader(a);
return!GL.getShaderParameter(a,GL.COMPILE_STATUS)?(DEBUG&&alert(GL.getShaderInfoLog(a)),null):a},getVertexShader:function(){var a=GL.createShader(GL.VERTEX_SHADER);GL.shaderSource(a,"        attribute vec3 aVertexNormal, aVertexPosition;\n        attribute vec2 aTextureCoord;\n\n        uniform mat4 uMVMatrix,uPMatrix, OBJ_Matrix, V_Matrix;\n        uniform int render, shadow;\n\n        varying vec2 vTextureCoord;\n        varying vec3 vNormal, sc_pos;\n\n        const vec3 LIGHT_POS=vec3(0.,0.,4.);\n\n        void main(void) {\n               vec4 pos;\n               vTextureCoord=aTextureCoord;\n               sc_pos=vec3(OBJ_Matrix*vec4(aVertexPosition, 1.)); //position in scene ref\n               vNormal=mat3(OBJ_Matrix)*aVertexNormal;\n\n               if (shadow==1) {\n                  vec3 n=normalize(sc_pos-LIGHT_POS);\n                  vec3 position=sc_pos-(sc_pos[2]/n[2])*n+vec3(0.,0.,0.001);\n                  pos=V_Matrix * vec4(position,1.);\n\n               } else {\n                  pos=uMVMatrix * vec4(aVertexPosition,1.);\n               }\n               \n               \n               gl_Position = uPMatrix * pos;\n        }\n\n");
GL.compileShader(a);return!GL.getShaderParameter(a,GL.COMPILE_STATUS)?(alert(GL.getShaderInfoLog(a)),null):a},init:function(){a.fragmentShader=a.getFragmentShader();a.vertexShader=a.getVertexShader();a.SHADER_PROGRAM=GL.createProgram();GL.attachShader(a.SHADER_PROGRAM,a.vertexShader);GL.attachShader(a.SHADER_PROGRAM,a.fragmentShader);GL.linkProgram(a.SHADER_PROGRAM);if(!GL.getProgramParameter(a.SHADER_PROGRAM,GL.LINK_STATUS))return DEBUG&&alert("Could not initialise shaders"),!1;a.SHADER_PROGRAM.vertexPositionAttribute=
GL.getAttribLocation(a.SHADER_PROGRAM,"aVertexPosition");GL.enableVertexAttribArray(a.SHADER_PROGRAM.vertexPositionAttribute);a.SHADER_PROGRAM.textureCoordAttribute=GL.getAttribLocation(a.SHADER_PROGRAM,"aTextureCoord");a.SHADER_PROGRAM.vertexNormalAttribute=GL.getAttribLocation(a.SHADER_PROGRAM,"aVertexNormal");GL.enableVertexAttribArray(a.SHADER_PROGRAM.vertexNormalAttribute);a.SHADER_PROGRAM.pMatrixUniform=GL.getUniformLocation(a.SHADER_PROGRAM,"uPMatrix");a.SHADER_PROGRAM.mvMatrixUniform=GL.getUniformLocation(a.SHADER_PROGRAM,
"uMVMatrix");a.SHADER_PROGRAM.shadow=GL.getUniformLocation(a.SHADER_PROGRAM,"shadow");a.SHADER_PROGRAM.uSamplers=GL.getUniformLocation(a.SHADER_PROGRAM,"uSampler0");a.SHADER_PROGRAM.white=GL.getUniformLocation(a.SHADER_PROGRAM,"white");a.SHADER_PROGRAM.screenRed=GL.getUniformLocation(a.SHADER_PROGRAM,"screenRed");a.SHADER_PROGRAM.render=GL.getUniformLocation(a.SHADER_PROGRAM,"render");a.SHADER_PROGRAM.OBJ_Matrix=GL.getUniformLocation(a.SHADER_PROGRAM,"OBJ_Matrix");a.SHADER_PROGRAM.V_Matrix=GL.getUniformLocation(a.SHADER_PROGRAM,
"V_Matrix");a.SHADER_PROGRAM.cam_pos=GL.getUniformLocation(a.SHADER_PROGRAM,"cam_pos");a.set()},set:function(){GL.enableVertexAttribArray(a.SHADER_PROGRAM.textureCoordAttribute);GL.useProgram(a.SHADER_PROGRAM);SHADER_PROGRAM=a.SHADER_PROGRAM},unset:function(){GL.disableVertexAttribArray(a.SHADER_PROGRAM.textureCoordAttribute)}};a.init();return a},VertexBuffer=function(a){a.enableOptions=a.options!==!1;a.options=a.options||0;var b={loaded:!1,drawMode:a.drawMode||GL.STATIC_DRAW,init:function(){b.vertex=
a.vertex;b.offsets=[0,12,24,a.options>0?32:0];b.length=32+a.options*4;b.load()},load:function(){a.buffer=GL.createBuffer();GL.bindBuffer(GL.ARRAY_BUFFER,a.buffer);GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a.vertex),b.drawMode);a.bufferNumItems=a.vertex.length/b.length;b.loaded=!0},draw:function(){GL.bindBuffer(GL.ARRAY_BUFFER,a.buffer);GL.vertexAttribPointer(SHADER_PROGRAM.vertexPositionAttribute,3,GL.FLOAT,!1,b.length,b.offsets[0]);GL.vertexAttribPointer(SHADER_PROGRAM.vertexNormalAttribute,
3,GL.FLOAT,!1,b.length,b.offsets[1]);GL.vertexAttribPointer(SHADER_PROGRAM.textureCoordAttribute,2,GL.FLOAT,!1,b.length,b.offsets[2])}};b.init();return b},VertexIndexBuffer=function(a){if(a.indices==="undefined")throw"ERROR : constructor called without enough arguments in VertexIndexBuffer!";var b={loaded:!1,load:function(){a.buffer=GL.createBuffer();GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,a.buffer);GL.bufferData(GL.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),GL.STATIC_DRAW);a.buffer.numItems=a.indices.length;
b.loaded=!0},draw:function(){GL.bindBuffer(GL.ELEMENT_ARRAY_BUFFER,a.buffer);GL.drawElements(GL.TRIANGLES,a.buffer.numItems,GL.UNSIGNED_SHORT,0)}};b.load();return b},Matrix={I4:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],I3:[1,0,0,0,1,0,0,0,1],pMatrix:!1,pMatrixInv:!1,stack:[],mvPushMatrix:function(){this.stack.push(lib_matrix_base4.copyNew(this.mvMatrix))},mvPopMatrix:function(){this.stack.pop()},loadIdentity:function(){this.mvMatrix[0]=1;this.mvMatrix[1]=0;this.mvMatrix[2]=0;this.mvMatrix[3]=0;this.mvMatrix[4]=
0;this.mvMatrix[5]=1;this.mvMatrix[6]=0;this.mvMatrix[7]=0;this.mvMatrix[8]=0;this.mvMatrix[9]=0;this.mvMatrix[10]=1;this.mvMatrix[11]=0;this.mvMatrix[12]=0;this.mvMatrix[13]=0;this.mvMatrix[14]=0;this.mvMatrix[15]=1},loadMvMatrix:function(a){this.mvMatrix[0]=a[0];this.mvMatrix[1]=a[1];this.mvMatrix[2]=a[2];this.mvMatrix[3]=a[3];this.mvMatrix[4]=a[4];this.mvMatrix[5]=a[5];this.mvMatrix[6]=a[6];this.mvMatrix[7]=a[7];this.mvMatrix[8]=a[8];this.mvMatrix[9]=a[9];this.mvMatrix[10]=a[10];this.mvMatrix[11]=
a[11];this.mvMatrix[12]=a[12];this.mvMatrix[13]=a[13];this.mvMatrix[14]=a[14]},loadNMatrix:function(a){this.nMatrix[0]=a[0];this.nMatrix[1]=a[1];this.nMatrix[2]=a[2];this.nMatrix[3]=a[4];this.nMatrix[4]=a[5];this.nMatrix[5]=a[6];this.nMatrix[6]=a[8];this.nMatrix[7]=a[9];this.nMatrix[8]=a[10]},mvUniform:function(){GL.uniformMatrix4fv(SHADER_PROGRAM.mvMatrixUniform,!1,this.stack[0])},vUniform:function(){GL.uniformMatrix4fv(SHADER_PROGRAM.V_Matrix,!1,this.mvMatrix)},nUniform:function(){GL.uniformMatrix3fv(SHADER_PROGRAM.nMatrixUniform,
!1,this.nMatrix)},pUniform:function(){GL.uniformMatrix4fv(SHADER_PROGRAM.pMatrixUniform,!1,this.pMatrix)},set_pMatrix:function(a){this.pMatrix=a;this.pUniform()},setPMatrix:function(a,b,c,d){this.pMatrix=lib_matrix_proj.makePerspectiveNew(a,b,c,d);this.pMatrixInv=lib_matrix_base.invertNew(this.pMatrix,4);this.pick_a=2/CONTEXT3D.width;this.pick_b=-2/CONTEXT3D.height},init:function(){this.mvMatrix=lib_matrix_base4.getI4();this.nMatrix=lib_matrix_base3.get_I3()},pickVector:function(a){return[a[0]*this.pMatrixInv[0],
a[1]*this.pMatrixInv[5],-1]}};Matrix.init();
var LAST_TEXTURE=!1,Texture=function(a){var b={loaded:!1,texture0:GL.createTexture(),image:new Image,init:function(){b.image.src=GAME.rootDir+a.imageURL;b.image.onload=function(){b.loadLR();if(a.onload)a.onload(b.image)}},loadLR:function(){GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0);GL.bindTexture(GL.TEXTURE_2D,b.texture0);GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,b.image);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,
GL.LINEAR_MIPMAP_LINEAR);GL.generateMipmap(GL.TEXTURE_2D);GL.bindTexture(GL.TEXTURE_2D,null);b.loaded=!0},draw:function(){if(LAST_TEXTURE==b)return!1;GL.bindTexture(GL.TEXTURE_2D,b.texture0);LAST_TEXTURE=b;return!0}};b.init();return b},TextureCanvas=function(a){var b={loaded:!1,texture0:GL.createTexture(),init:function(){b.load()},load:function(){GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0);GL.bindTexture(GL.TEXTURE_2D,b.texture0);GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,a.canvas);
GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.NEAREST_MIPMAP_LINEAR);GL.generateMipmap(GL.TEXTURE_2D);GL.bindTexture(GL.TEXTURE_2D,null);b.loaded=!0},draw:function(){GL.bindTexture(GL.TEXTURE_2D,b.texture0);LAST_TEXTURE=!1}};b.init();return b},TextureVideo=function(a){var b={loaded:!1,texture0:GL.createTexture(),init:function(){GL.bindTexture(GL.TEXTURE_2D,b.texture0);GL.texImage2D(GL.TEXTURE_2D,0,GL.RGB,GL.RGB,GL.UNSIGNED_BYTE,
a.video);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.LINEAR);GL.bindTexture(GL.TEXTURE_2D,null);b.loaded=!0},refresh:function(){GL.bindTexture(GL.TEXTURE_2D,b.texture0);GL.texImage2D(GL.TEXTURE_2D,0,GL.RGB,GL.RGB,GL.UNSIGNED_BYTE,a.video);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE);
GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR);GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.LINEAR)},draw:function(){b.refresh();LAST_TEXTURE=!1}};b.init();return b},Renders={misc:0,chessman:1,board:2,ground:3,screen:4,current:!1,set:function(a){if(this.current===a)return!1;GL.uniform1i(SHADER_PROGRAM.render,a);this.current=a;return!0},reset:function(){this.current=!1}},SCENE,I,Scene=function(){var a={meshes:[],
obj_chessman:[],obj_shadow:[],obj_square:[],obj_pickable:[],shadowMode:!1,load:function(){GL.clearDepth(1);GL.enable(GL.DEPTH_TEST);GL.depthFunc(GL.LEQUAL);GL.enable(GL.CULL_FACE);GL.cullFace(GL.BACK);GL.frontFace(GL.CCW);GL.stencilOp(GL.KEEP,GL.DECR,GL.INCR);GL.enable(GL.DITHER);Matrix.pUniform();GL.clearColor(0,0,0,0);GL.stencilFunc(GL.EQUAL,0,255);GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA);GL.uniform1i(SHADER_PROGRAM.uSampler,0);GL.uniform1f(SHADER_PROGRAM.screenRed,0)},drawPhysics:function(){VIEW.drawPhysics();
CONTEXT3D.nav.drawPhysics();for(var b=0;b<a.obj_chessman.length;b++)a.obj_chessman[b].drawPhysics&&a.obj_chessman[b].drawPhysics();TOWERLEFT.obj&&TOWERLEFT.obj.drawPhysics();TOWERRIGHT.obj&&TOWERRIGHT.obj.drawPhysics();VIDEOSCREEN.drawPhysics()},draw:function(){GL.viewport(0,0,CONTEXT3D.width,CONTEXT3D.height);GL.clear(GL.COLOR_BUFFER_BIT|GL.DEPTH_BUFFER_BIT);GL.clearStencil(255);VIEW.draw();a.drawAlone();CONTEXT3D.get_active()&&window.requestAnimationFrame(a.draw)},pick:function(){var b=9999,c,d,
e=!1;for(d=0;d<a.obj_pickable.length;d++)if(a.obj_pickable[d].pickable&&(c=a.obj_pickable[d].pick(RAY))&&!(c>b))b=c,e=a.obj_pickable[d];e&&e.doPick()},drawAlone:function(){Matrix.vUniform();for(I=0;I<a.obj_chessman.length;I++)Matrix.mvPushMatrix(),a.obj_chessman[I].draw(),Matrix.mvPopMatrix();for(I=0;I<a.obj_square.length;I++)Matrix.mvPushMatrix(),a.obj_square[I].draw(),Matrix.mvPopMatrix();Matrix.mvPushMatrix();TOWERRIGHT.draw();Matrix.mvPopMatrix();Matrix.mvPushMatrix();TOWERLEFT.draw();Matrix.mvPopMatrix();
Matrix.mvPushMatrix();TABLE.draw();Matrix.mvPopMatrix();GL.enable(GL.BLEND);Matrix.mvPushMatrix();VIDEOSCREEN.draw();Matrix.mvPopMatrix();GL.enable(GL.STENCIL_TEST);a.shadowMode=!0;GL.uniform1i(SHADER_PROGRAM.shadow,1);GL.stencilMask(255);GL.clearStencil(0);for(I=0;I<a.obj_shadow.length;I++)Matrix.mvPushMatrix(),a.obj_shadow[I].draw(),Matrix.mvPopMatrix();GL.stencilMask(0);GL.uniform1i(SHADER_PROGRAM.shadow,0);GL.disable(GL.STENCIL_TEST);GL.disable(GL.BLEND);a.shadowMode=!1;Matrix.mvPushMatrix();
GROUND.draw&&GROUND.draw();Matrix.mvPopMatrix();GL.flush()},addObjChessman:function(b){a.obj_chessman.push(b);a.obj_chessman.sort(function(a,b){return a.numType+(a.white?8:0)-(b.numType+(b.white?8:0))})},addObjShadow:function(b){a.obj_shadow.push(b)},addPickable:function(b){a.obj_pickable.push(b)},addObjSquare:function(b){a.obj_square.push(b)}};SCENE=a;a.load();return a},VIEW,View=function(a){a.movement=!1;var b={cam:a.cam,theta:a.theta,phi:a.phi,mvMatrix:lib_matrix_base4.getI4(),mvMatrixInv:lib_matrix_base4.getI4(),
cam:a.cam,type:"view",addMovement:function(b){a.movement=b},save:function(){return{theta:b.theta,phi:b.phi,cam:lib_array.copy(b.cam)}},drawPhysics:function(){if(a.movement)a.movement.move(VIEW.cam)?VIEW.move():(a.movement.callback(),a.movement=!1)},draw:function(){GL.uniform3fv(SHADER_PROGRAM.cam_pos,b.cam);Matrix.loadMvMatrix(b.mvMatrix)},move:function(){lib_matrix_base4.copy(Matrix.I4,b.mvMatrix);lib_matrix_rot.rotateYFast(b.mvMatrix,Math.PI);lib_matrix_rot.rotateZFast(b.mvMatrix,b.theta);lib_matrix_rot.rotateXFast(b.mvMatrix,
b.phi);lib_matrix_mv.translateRot(b.mvMatrix,b.cam);lib_matrix_mv.invert(b.mvMatrixInv,b.mvMatrix);SHADER_PROGRAM.has_lightCam&&GL.uniform3fv(SHADER_PROGRAM.lightCam,[Math.sin(b.phi)*-Math.sin(b.theta),Math.sin(b.phi)*Math.cos(b.theta),-Math.cos(b.phi)])},rotate_soft:function(c,d){var e=0,f=b.theta,g=lib_vector3D.vnew(b.cam),i=c*CONTEXT3D.fr/d,k=CONTEXT3D.fr/d,h=1/k;a.movement={move:function(){if(e>1)return b.setPos([g[0]*Math.cos(c)-g[1]*Math.sin(c),g[1]*Math.cos(c)+g[0]*Math.sin(c),g[2]]),b.setTheta(f+
c),!1;var a=Math.sin(e*Math.PI/2);b.setPos([g[0]*Math.cos(a*h*i)-g[1]*Math.sin(a*h*i),g[1]*Math.cos(a*h*i)+g[0]*Math.sin(a*h*i),g[2]]);b.setTheta(f+a*h*i);e+=k;return!0},callback:function(){return!0}}},setTheta:function(a){b.theta=a;b.move()},setPhi:function(a){b.phi=a;b.move()},setPos:function(a){b.cam0=lib_vector3D.vnew(a);b.setCam(a);b.move()},setPosThetaPhi:function(a,d,e){b.cam=a;b.theta=d;b.phi=e;b.move()},translate:function(a){a=lib_vector3D.addNew(b.cam,a);b.setCam(a);b.move();SCENE.sortObjMiddle()},
moveFront:function(){b.translate([Math.sin(b.theta)*-Engine3D.params.step,Math.cos(b.theta)*Engine3D.params.step,0])},moveBack:function(){b.translate([Math.sin(b.theta)*Engine3D.params.step,Math.cos(b.theta)*-Engine3D.params.step,0])},turnRight:function(){b.theta-=Engine3D.params.stepTheta},turnLeft:function(){b.theta+=Engine3D.params.stepTheta},turnTheta:function(a){b.theta+=a;b.setSpheric();b.move()},turnPhi:function(a){b.phi+=a;b.setSpheric();b.move()},setSpheric:function(){b.cam=[b.R*Math.sin(b.theta)*
Math.sin(b.phi),-b.R*Math.cos(b.theta)*Math.sin(b.phi),Math.min(b.Z,b.R*Math.cos(b.phi))]},computeR:function(){b.R=lib_vector3D.norm(b.cam);b.Z=b.cam[2];b.setSpheric()},setCam:function(a){b.cam=a;return!0},dirRefScene:function(a){var d=a[0],e=a[1];a[0]=b.mvMatrix[0]*d+b.mvMatrix[1]*e+b.mvMatrix[2]*a[2];a[1]=b.mvMatrix[4]*d+b.mvMatrix[5]*e+b.mvMatrix[6]*a[2];a[2]=b.mvMatrix[8]*d+b.mvMatrix[9]*e+b.mvMatrix[10]*a[2]},orRefScene:function(a){a[0]=b.mvMatrixInv[12];a[1]=b.mvMatrixInv[13];a[2]=b.mvMatrixInv[14]},
distanceToCam:function(a){return lib_vector3D.distance(b.cam,a)}};return VIEW=b},NAVIGATION,Navigation=function(){var a={oldX:0,oldY:0,CLIC:!1,keysDown:[]},b={mouseMove:function(b){if(a.CLIC)VIEW.turnTheta(Engine3D.params.mouse_sensitivityX*(a.oldX-b.clientX)),VIEW.turnPhi(Engine3D.params.mouse_sensitivityY*(-a.oldY+b.clientY)),a.oldX=b.clientX,a.oldY=b.clientY},addKeyDown:function(b){a.keysDown.indexOf(b)==-1&&a.keysDown.push(b)},keyDown:function(){return!1},drawPhysics:function(){for(var b=0;b<
a.keysDown.length;b++)switch(a.keysDown[b]){case 37:VIEW.turnLeft();break;case 39:VIEW.turnRight();break;case 38:VIEW.moveFront();break;case 40:VIEW.moveBack();break;case 33:VIEW.translate([0,0,-0.02]);break;case 34:VIEW.translate([0,0,0.02])}VIEW.move()},clearKeys:function(){a.keysDown=[]},keyUp:function(a){a.preventDefault();switch(a.keyCode){case 37:case 81:case 65:NAVIGATION.delKeyDown(37);break;case 68:case 39:NAVIGATION.delKeyDown(39);break;case 90:case 38:NAVIGATION.delKeyDown(38);break;case 83:case 40:NAVIGATION.delKeyDown(40);
break;case 33:NAVIGATION.delKeyDown(33);break;case 34:NAVIGATION.delKeyDown(34)}},delKeyDown:function(b){lib_array.removeElement(a.keysDown,b)},mouseOut:function(){a.CLIC=!1},mouseRoll:function(a){a.preventDefault();return!1},mouseUp:function(c){switch(c.button){case 0:Math.abs(c.clientX-a.oldX)+Math.abs(c.clientY-a.oldY)<10&&b.click(c),a.CLIC=!1}},click:function(a){if(!GAME.started)return!1;RAY.set([a.clientX,a.clientY]);SCENE.pick();return!0},mouseDown:function(b){switch(b.button){case 0:a.CLIC=
!0,a.oldX=b.clientX,a.oldY=b.clientY}},set:function(){CONTEXT3D.set_nav(b);CONTEXT3D.cv.onmousemove=NAVIGATION.mouseMove;CONTEXT3D.cv.onmousedown=NAVIGATION.mouseDown;CONTEXT3D.cv.onmouseup=NAVIGATION.mouseUp;CONTEXT3D.cv.onmouseout=NAVIGATION.mouseOut;window.onresize=CONTEXT3D.sizeCanvas},unset:function(){CONTEXT3D.cv.onmousemove=function(){return!1};CONTEXT3D.cv.onmousedown=function(){return!0};CONTEXT3D.cv.onmouseup=function(){return!1};CONTEXT3D.cv.onmouseout=function(){return!1};window.removeEventListener("DOMMouseScroll",
NAVIGATION.mouseRoll,!1);window.onresize=function(){return!1}}};return b},CONTEXT3D,GL,Context3D=function(a){a.active=!1;var b={cv:lib_dom.get(a.canvasId),fullscreen:a.fullscreen&&!0,setParams:function(){b.fr=ENGINE3D.current_params.fr;b.angle=ENGINE3D.current_params.angle;b.zNear=a.zNear||ENGINE3D.current_params.zNear;b.zFar=a.zFar||ENGINE3D.current_params.zFar},get_active:function(){return a.active},init:function(){b.setParams();b.initGL();b.sizeCanvas();b.shaders0=Shaders();b.view=a.view;b.scene=
Scene({});b.nav0=Navigation()},set_nav:function(a){NAVIGATION=this.nav=a},initGL:function(){try{GL=b.cv.getContext("experimental-webgl",{antialias:!0}),b.sizeCanvas()}catch(a){GAME.troubleshooting()}},changeCanvasSize:function(a,d){b.cv.width=a;b.cv.height=d},sizeCanvas:function(){b.fullscreen?(b.width=window.innerWidth,b.height=window.innerHeight,b.changeCanvasSize(b.width,b.height)):(b.width=b.cv.width,b.height=b.cv.height);a.cvWH=[-0.5*b.width,-0.5*b.height];a.cvOffset=lib_dom.getPos(b.cv);GL.viewport(0,
0,b.width,b.height);Matrix.setPMatrix(b.angle,b.width/b.height,b.zNear,b.zFar);ENGINE3D.loaded&&Matrix.pUniform()},make_cvCo:function(b){lib_vector.sub(b,a.cvOffset);lib_vector.divideXY(b,a.cvWH);b[0]+=1;b[1]+=1},setFullScreen:function(){b.fullscreen=!0;b.cv.style.position="absolute";b.cv.style.top="0px";b.cv.style.left="0px";b.cv.style.marginTop="0px";b.sizeCanvas()},unsetFullScreen:function(){b.fullscreen=!1;b.cv.style.marginTop="20px";b.cv.width=800;b.cv.height=520;b.cv.style.position="static";
b.sizeCanvas()},displayOff:function(){b.timer&&clearInterval(b.timer);a.active=!1},displayOn:function(){a.active=!0;SCENE.draw();b.timer=setInterval("SCENE.drawPhysics()",b.fr)},displayOnNoPhysics:function(){a.active=!0;SCENE.draw()}};CONTEXT3D=b;b.init();return b},Obj=function(a){a.mvMatrix=a.mvMatrix||lib_matrix_base4.getI4();a.origin=a.origin||lib_matrix_mv.getDepl(a.mvMatrix);a.render=a.render||0;a.texture=a.texture||!1;a.moving=!1;var b={pickable:!1,origin:a.origin,mvMatrix:a.mvMatrix,draw:function(){GL.uniformMatrix4fv(SHADER_PROGRAM.OBJ_Matrix,
!1,b.mvMatrix);lib_matrix_mv.combine(Matrix.stack[0],b.mvMatrix);GL.uniformMatrix4fv(SHADER_PROGRAM.mvMatrixUniform,!1,b.mvMatrix);Renders.set(a.render);Matrix.mvUniform();a.texture&&!SCENE.shadowMode&&a.texture.draw();a.mesh.draw();return!0},load:function(){a.mvMatrixInv=lib_matrix_mv.invertNew(b.mvMatrix);a.mesh.load()},computeInvMatrix:function(){lib_matrix_mv.invert(a.mvMatrixInv,b.mvMatrix)},setTexture:function(b){a.texture=b},translate:function(a){lib_matrix_mv.translate(b.mvMatrix,a)},setPos:function(a){lib_matrix_mv.setPos(b.mvMatrix,
a)},getPos:function(){return lib_matrix_mv.getDepl(b.mvMatrix)},move_parabollic:function(c,d,e,f,g){var i=0,k=e/CONTEXT3D.fr,h=b.getPos(),j=!1,l=CONTEXT3D.fr*(c[0]-h[0])/e,n=CONTEXT3D.fr*(c[1]-h[1])/e,p=c[2]-h[2],o=Math.sqrt((c[0]-h[0])*(c[0]-h[0])+(c[1]-h[1])*(c[1]-h[1])),m=lib_vector3D.distance(h,c)*0.5,q=Math.sqrt(l*l+n*n),r=d/(m*m);a.drawPhysics=function(){var e=i*q;e>o-f&&!j&&(g(),j=!0);e=[h[0]+l*i,h[1]+n*i,h[2]+(d-r*(e-m)*(e-m))+p*e/o];i++;if(i>=k)e=c,a.moving=!1;b.setPos(e)};a.moving=!0},rotate_soft:function(c,
d,e){var f=0,g=lib_vector3D.vnew(b.getPos()),i=d*CONTEXT3D.fr/e,k=CONTEXT3D.fr/e,h=1/k;a.moving=!0;a.drawPhysics=function(){if(f>1)return b.setTheta(c+d),b.setPos([g[0]*Math.cos(d)-g[1]*Math.sin(d),g[1]*Math.cos(d)+g[0]*Math.sin(d),g[2]]),a.moving=!1;var e=Math.sin(f*Math.PI/2);b.setTheta(c+e*h*i);b.setPos([g[0]*Math.cos(e*h*i)-g[1]*Math.sin(e*h*i),g[1]*Math.cos(e*h*i)+g[0]*Math.sin(e*h*i),g[2]]);f+=k;return!0}},drawPhysics:function(){a.moving&&a.drawPhysics()},pick:function(a){if(!b.octree)return!1;
a.changeRef(b.mvMatrix);return b.octree.pick(a)},doPick:function(){return!1},setdoPick:function(a){b.doPick=a},resetPos:function(){lib_matrix_base4.setI4(b.mvMatrix)},setTheta:function(a){lib_matrix_base4.setI4(b.mvMatrix);lib_matrix_rot.rotateZFast(b.mvMatrix,a)},rotateX:function(a){lib_matrix_rot.rotateXFast(b.mvMatrix,a)},rotateY:function(a){lib_matrix_rot.rotateYFast(b.mvMatrix,a)},rotateZ:function(a){lib_matrix_rot.rotateZFast(b.mvMatrix,a)},setTexture:function(b){a.texture=b}};return b},JSONobj=
function(a){a.render=a.render||0;a.mvMatrix=a.mvMatrix||lib_matrix_base4.getI4();a.origin=a.origin||lib_matrix_mv.getDepl(a.mvMatrix);var b={pickable:!0,origin:a.origin,loaded:!1,type:"JSONObj",textureURL:a.textureURL,mvMatrix:a.mvMatrix,load:function(c){b.jsonObj=JSON.parse(c);b.mesh=Mesh({vertexBufferArray:b.jsonObj.vertex,vertexIndexBufferArray:b.jsonObj.indices,options:2});b.texture=a.texture?a.texture:Texture({imageURL:b.textureURL});b.octree=Octree({mesh:b.mesh,jsonOctree:b.jsonObj.octree});
b.obj=Obj({mesh:b.mesh,texture:b.texture,render:a.render,mvMatrix:b.mvMatrix});b.draw=function(){a.render==Renders.chessman&&GL.uniform1i(SHADER_PROGRAM.white,a.white);b.obj.draw()};b.drawPhysics=b.obj.drawPhysics;return b},draw:function(){},pick:function(a){a.changeRef(b.mvMatrix);return b.octree.pick(a)},doPick:function(){}};lib_ajax.get(a.jsonURL,b.load);return b},SKYDOMEOBJ,SkydomeObj=function(a){a.current_hour=parseInt(lib_dom.getValue("sun_hour"))+Engine3D.params.hour_offset;a.current_month=
7;a.current_latitude=lib_maths.degToRad(lib_dom.getValue("sun_latitude"));a.current_monthSelected=lib_dom.get("sun_month0");a.mesh=Skydome({bands:10,R:50,rings:15,phi0:Math.PI});a.texture=Texture({imageURL:"engine3D/ressources/skydomes/4.jpg"});var b=Obj({mesh:a.mesh,render:Renders.sky,texture:a.texture});b.set_month=function(c,d){if(a.current_monthSelected)a.current_monthSelected.className="month";d.className="month monthSelected";a.current_monthSelected=d;a.current_month=c;b.refresh()};b.set_hour=
function(){var c=Engine3D.params.hour_offset+parseInt(lib_dom.getValue("sun_hour"));if(c==a.current_hour)return!1;a.current_hour=c;b.refresh();return!0};b.set_latitude=function(){var c=lib_maths.degToRad(lib_dom.getValue("sun_latitude"));if(c==a.current_latitude)return!1;a.current_latitude=c;b.refresh();return!0};b.refresh=function(){var a=b.refreshPos();LIGHTMAP.refresh_sun(a)};b.refreshPos=function(){var a=b.get_params();b.resetPos();b.rotateY(a.phi);b.rotateZ(-Math.PI/2+a.theta);return a};b.get_params=
function(){var b=lib_calendar.get_sunAngles2(a.current_month,a.current_hour,a.current_latitude);return{theta:-b.azimuth,phi:b.zenith}};b.dispatch=function(){SCENE.addObjEnd(b)};b.type="skydomeObj";b.refreshPos();SKYDOMEOBJ=b},VideoScreenObj=function(a){a.mesh=Quad({w:a.w,h:a.h});a.mvMatrix=lib_matrix_base4.getI4();lib_matrix_rot.rotateXFast(a.mvMatrix,Math.PI/2);lib_matrix_rot.rotateZFast(a.mvMatrix,3*Math.PI/2);lib_matrix_mv.setPos(a.mvMatrix,a.position);a.loaded=!1;a.red=!1;var b=Obj({mesh:a.mesh,
mvMatrix:a.mvMatrix,render:Renders.screen,texture:Texture({imageURL:"engine3D/ressources/waitScreen.jpg"})});a.videoURL?(a.videoElt=document.createElement("video"),a.videoElt.setAttribute("autoplay","true"),a.videoElt.setAttribute("width",a.def.toString()),a.videoElt.setAttribute("height",a.def.toString()),a.videoElt.setAttribute("onplay","this.onplay2()"),a.videoElt.onplay2=function(){a.loaded=!0;b.setTexture(TextureVideo({video:a.videoElt}))},a.videoElt.src=a.videoURL):(a.videoElt.setAttribute("onplay",
"this.onplay2()"),a.videoElt.onplay2=function(){b.setTexture(TextureVideo({video:a.videoElt}));a.loaded=!0},DEBUG=a.videoElt);b.setTheta=function(a){b.mvMatrix=lib_matrix_base4.getI4();lib_matrix_rot.rotateXFast(b.mvMatrix,Math.PI/2);lib_matrix_rot.rotateZFast(b.mvMatrix,Math.PI/2+a)};b.setColor=function(c){if(a.red&&c||!a.red&&!c)return!1;var d=0;a.red=c;b.drawPhysics=function(){d+=0.01;if(d>1)d=1,b.drawPhysics=function(){return!1};c?GL.uniform1f(SHADER_PROGRAM.screenRed,d):GL.uniform1f(SHADER_PROGRAM.screenRed,
1-d)};return!0};return b},LAST_MESH=!1,Mesh=function(a){if(a.options!==!1)a.options=a.options||0;a.drawMode=a.drawMode||GL.STATIC_DRAW;var b={loaded:!1,load:function(){a.vertexBuffer=VertexBuffer({vertex:a.vertexBufferArray,drawMode:a.drawMode,options:a.options});a.vertexIndexBuffer=VertexIndexBuffer({indices:a.vertexIndexBufferArray});b.loaded=!0},draw:function(){b!=LAST_MESH&&(a.vertexBuffer.draw(),LAST_MESH=b);a.vertexIndexBuffer.draw()},getFace:function(b){var d=[],e,f;for(e=0;e<3;e++)f=a.vertexIndexBufferArray[3*
b+e],d.push([a.vertexBufferArray[f*10],a.vertexBufferArray[f*10+1],a.vertexBufferArray[f*10+2]]);return d}};b.load();return b},Pave=function(a){var b=a.w/2,c=a.h/2,a=a.d/2,b=lib_buffersArray.concat([-b,-c,a,b,-c,a,b,c,a,-b,c,a,-b,-c,-a,-b,c,-a,b,c,-a,b,-c,-a,-b,c,-a,-b,c,a,b,c,a,b,c,-a,-b,-c,-a,b,-c,-a,b,-c,a,-b,-c,a,b,-c,-a,b,c,-a,b,c,a,b,-c,a,-b,-c,-a,-b,-c,a,-b,c,a,-b,c,-a],[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,
0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]);return Mesh({vertexBufferArray:b,vertexIndexBufferArray:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})},Quad=function(a){a.textureScale=a.textureScale||1;a=lib_buffersArray.concat([-a.w/2,-a.h/2,0,a.w/2,-a.h/2,0,a.w/2,a.h/2,0,-a.w/2,a.h/2,0],[0,0,1,0,0,1,0,0,1,0,0,1],[0,0,a.textureScale,0,a.textureScale,a.textureScale,
0,a.textureScale]);return Mesh({vertexBufferArray:a,vertexIndexBufferArray:[0,1,2,0,2,3]})},Skydome=function(a){a.vertices=[];a.indices=[];var b,c,d,e,f,g,i=0;f=a.phi0/a.rings;g=2*Math.PI/a.bands;for(b=0;b<=a.rings;b++){d=b*f;for(c=0;c<=a.bands;c++)e=c*g,a.vertices.push(a.R*Math.sin(d)*Math.cos(e),a.R*Math.sin(d)*Math.sin(e),a.R*Math.cos(d),Math.sin(d)*Math.cos(e),Math.sin(d)*Math.sin(e),Math.cos(d),e*(1+1/g)/(2*Math.PI),(Math.PI-d)/Math.PI),b!=0&&a.indices.push(i-1,i,i-a.bands-1,i-1,i-a.bands-1,
i-a.bands-2),i++}return Mesh({vertexBufferArray:a.vertices,vertexIndexBufferArray:a.indices})},Audiotrack=function(a){a.elt=document.createElement("audio");a.elt.autoplay=!1;a.elt.preload=!0;a.elt.controls=!1;a.elt.onended=function(){a.elt.currentTime=0;a.elt.pause()};a.elt.src=a.soundURL;return{play:function(){a.elt.play()}}},WEBRTC,Webrtc=function(){var a=-1,b,c=-1,d=null,e=null,f=null,g=null,i=!1,k=0,h={peerList:[],data:!1,ajaxR:!1,afterConnect:lib_dom.get("afterConnect"),beforeConnect:lib_dom.get("beforeConnect"),
inputName:lib_dom.get("name"),connectButton:lib_dom.get("connect"),init:function(){window.onbeforeunload=h.disconnect;navigator.webkitGetUserMedia?h.getUserMedia():GAME.troubleshooting()},get_myName:function(){return b},sendMsg:function(a){c!=-1&&h.sendToPeer(c,a)},setCallState:function(a){k=a},checkPeerConnection:function(){return!f?0:1},gotStream:function(a){var b=webkitURL.createObjectURL(a);document.getElementById("localView").src=b;g=a},gotStreamFailed:function(a){alert("Failed to get access to local media. Error code was "+
a.code+".")},getUserMedia:function(){try{navigator.webkitGetUserMedia("video,audio",h.gotStream,h.gotStreamFailed)}catch(a){alert("getUserMedia error")}},peerExists:function(a){try{for(var b=document.getElementById("peers"),c=0;c<b.length;c++)if(parseInt(b.options[c].value)==a)return!0}catch(d){alert("Error searching for peer")}return!1},addPeer:function(a,b){try{var c=document.getElementById("peers");if(h.peerList.indexOf(a)!==-1)return!1;h.peerList.push(a);var d=document.createElement("option");
d.text=b;d.value=a;c.add(d,null);return!0}catch(e){alert("Error adding peer")}},checkPeer:function(a){h.freeCallback=h.addPeer;h.busyCallback=function(){};h.sendToPeer(a,"CHESS:ISBUSY")},removePeer:function(a){try{for(var b=document.getElementById("peers"),c=0;c<b.length;c++)if(parseInt(b.options[c].value)==a){b.remove(c);break}}catch(d){alert("Error removing peer")}},clearPeerList:function(){h.peerList=[];for(var a=document.getElementById("peers");a.length>0;)a.remove(0)},setSelectedPeer:function(a){try{for(var b=
document.getElementById("peers"),c=0;c<b.length;c++)if(parseInt(b.options[c].value)==a)return b.options[c].selected=!0}catch(d){alert("Error setting selected peer")}return!1},getPeerName:function(a){try{for(var b=document.getElementById("peers"),c=0;c<b.length;c++)if(parseInt(b.options[c].value)==a)return b.options[c].text}catch(d){alert("Error finding peer name")}},storeRemoteInfo:function(){try{var a=document.getElementById("peers");if(a.selectedIndex<0)return alert("Please select a peer."),!1;
else c=parseInt(a.options[a.selectedIndex].value)}catch(b){return alert("Error storing remote peer info"),!1}return!0},createPeerConnection:function(){f&&alert("PeerConnection object already exists");try{f=new webkitPeerConnection("STUN stun.l.google.com:19302",h.onSignalingMessage),f.onaddstream=h.onAddStream,f.onremovestream=h.onRemoveStream}catch(a){alert("Create PeerConnection error")}},doCallCheck:function(){if(h.storeRemoteInfo())h.freeCallback=h.doCall,h.busyCallback=function(){alert("This player has started a game :( . Please try another one ;) .")},
h.sendToPeer(c,"CHESS:ISBUSY")},doCall:function(){document.getElementById("call").disabled=!0;document.getElementById("peers").disabled=!0;h.createPeerConnection();f.addStream(g);h.setCallState(1);GAME.setBlack()},hangUp:function(){h.sendToPeer(c,"BYE");h.closeCall()},closeCall:function(){document.getElementById("remoteView").src="dummy";f?(f.close(),f=null):c=-1;document.getElementById("call").disabled=!1;document.getElementById("peers").disabled=!1;h.setCallState(0)},onAddStream:function(a){a=webkitURL.createObjectURL(a.stream);
document.getElementById("remoteView").src=a;GAME.start()},onRemoveStream:function(){document.getElementById("remoteView").src=""},onSignalingMessage:function(a){h.sendToPeer(c,a)},handleServerNotification:function(a){if(GAME.started)return!1;a=a.split(",");if(parseInt(a[2])==1){var b=parseInt(a[1]);if(!h.peerExists(b)){var c=document.getElementById("peers");c.length==1&&c.options[0].value==-1&&h.clearPeerList();h.addPeer(b,a[0]);document.getElementById("peers").disabled=!1;document.getElementById("call").disabled=
!1}}else if(parseInt(a[2])==0&&(h.removePeer(parseInt(a[1])),document.getElementById("peers").length==0))document.getElementById("peers").disabled=!0,h.addPeer(-1,"There is no player available")},handlePeerMessage:function(a,b){if(GAME.handleMsg(b,a))return!0;if(h.getPeerName(a)!=void 0)if(b.search("BYE")==0)h.closeCall();else if(f)try{f.processSignalingMessage(b)}catch(c){console.log("Process signaling message error 2 "+b)}else if(h.setSelectedPeer(a)&&h.storeRemoteInfo()){document.getElementById("call").disabled=
!0;document.getElementById("peers").disabled=!0;h.createPeerConnection();try{f.processSignalingMessage(b)}catch(d){console.log("Process signaling message error 1 "+b)}f.addStream(g)}},getIntHeader:function(a,b){var c=a.getResponseHeader(b);return c!=null&&c.length?parseInt(c):-1},hangingGetCallback:function(){try{if(!(e.readyState!=4||i)){if(e.status!=200)e.statusText();else{var b=h.getIntHeader(e,"Pragma");b==a?h.handleServerNotification(e.responseText):h.handlePeerMessage(b,e.responseText)}e&&(e.abort(),
e=null);a!=-1&&window.setTimeout(h.startHangingGet,0)}}catch(c){}},onHangingGetTimeout:function(){e.abort();e=null;a!=-1&&window.setTimeout(h.startHangingGet,0)},startHangingGet:function(){try{e=new XMLHttpRequest,e.onreadystatechange=h.hangingGetCallback,e.ontimeout=h.onHangingGetTimeout,e.open("GET","http://192.168.1.32:8888/wait?peer_id="+a,!0),e.send()}catch(b){alert("Start hanging get error")}},sendToPeer:function(b,c){if(a==-1)alert("Not connected.");else if(b==a)alert("Can't send a message to oneself.");
else{h.ajaxR=new XMLHttpRequest;h.ajaxR.open("POST","http://192.168.1.32:8888/message?peer_id="+a+"&to="+b,!1);h.ajaxR.setRequestHeader("Content-Type","text/plain");h.data=c;try{h.ajaxR.send(h.data),h.ajaxR=null}catch(d){h.data=c}}},resendData:function(){h.ajaxR.send(h.data);h.ajaxR=null},signInCallback:function(){try{if(d.readyState==4&&d.status==200){h.afterConnect.style.opacity="1";h.beforeConnect.style.opacity="0.5";h.inputName.disabled=!0;h.connectButton.innerHTML="Disconnect";var b=d.responseText.split("\n");
a=parseInt(b[0].split(",")[1]);h.clearPeerList();for(var c=0,e=1;e<b.length;++e)if(b[e].length>0){var f=b[e].split(",");h.checkPeer(parseInt(f[1]),f[0]);++c}c==0?h.addPeer(-1,"No player available"):(document.getElementById("peers").disabled=!1,document.getElementById("call").disabled=!1);h.startHangingGet();d=null}}catch(g){alert("Sign in error")}},signIn:function(){try{d=new XMLHttpRequest,d.onreadystatechange=h.signInCallback,d.open("GET","http://192.168.1.32:8888/sign_in?"+b,!0),d.send()}catch(a){alert("Start sign in error")}},
connect:function(){a!=-1?h.disconnect():(b=h.inputName.value.toLowerCase(),b.length==0?alert("Please enter a name"):h.signIn())},disconnect:function(){k==1&&h.hangUp();i=!0;h.afterConnect.style.opacity="0.5";h.beforeConnect.style.opacity="1";h.inputName.disabled=!1;h.connectButton.innerHTML="Connect";d&&(d.abort(),d=null);e&&(e.abort(),e=null);a!=-1&&(d=new XMLHttpRequest,d.open("GET","http://192.168.1.32:8888/sign_out?peer_id="+a,!1),d.send(),d=null,a=-1);h.clearPeerList();h.addPeer(-1,"Not connected");
document.getElementById("peers").disabled=!0;document.getElementById("call").disabled=!0;i=!1}};h.init();return WEBRTC=h},Engine3D=function(a){this.init=function(){this.current_params=Engine3D.params;this.game=Game(a);this.game.load();this.loaded=!0};this.start=function(){this.current_params=Engine3D.params;CONTEXT3D.setParams();CONTEXT3D.shaders0.set();CONTEXT3D.nav0.set();CONTEXT3D.setFullScreen();CONTEXT3D.displayOn();return!0};this.stop=function(){CONTEXT3D.shaders0.unset();CONTEXT3D.displayOff();
NAVIGATION.unset()}},Ray=function(){var a={direction:[0,0,0],origin:[0,0,0],pluck:[0,0,0,0,0,0],objectOrigin:[0,0,0],objectDirection:[0,0,0],objectPluck:[0,0,0,0,0,0],set:function(b){a.direction[0]=Matrix.pMatrixInv[0]*(Matrix.pick_a*b[0]-1);a.direction[1]=Matrix.pMatrixInv[5]*(Matrix.pick_b*b[1]+1);a.direction[2]=-1;VIEW.dirRefScene(a.direction);VIEW.orRefScene(a.origin);b=Math.sqrt(a.direction[0]*a.direction[0]+a.direction[1]*a.direction[1]+a.direction[2]*a.direction[2]);a.direction[0]/=b;a.direction[1]/=
b;a.direction[2]/=b;a.pluckerize(a.origin,a.direction,a.pluck)},pluckerize:function(a,c,d){d[0]=a[0]*c[1]-c[0]*a[1];d[1]=a[0]*c[2]-c[0]*a[2];d[2]=-c[0];d[3]=a[1]*c[2]-c[1]*a[2];d[4]=-c[2];d[5]=c[1]},changeRef:function(b){lib_matrix_mv.moveOrigin(b,a.origin,a.objectOrigin);lib_matrix_mv.moveDirection(b,a.direction,a.objectDirection);a.pluckerize(a.objectOrigin,a.objectDirection,a.objectPluck)},pluckTurn:function(b,c){var d=[b[0]*c[1]-c[0]*b[1],b[0]*c[2]-c[0]*b[2],b[0]-c[0],b[1]*c[2]-c[1]*b[2],b[2]-
c[2],c[1]-b[1]];return a.objectPluck[2]*d[3]+a.objectPluck[5]*d[1]+a.objectPluck[4]*d[0]+a.objectPluck[1]*d[5]+a.objectPluck[0]*d[4]+a.objectPluck[3]*d[2]},intersectQuad:function(b,c,d,e){var f=a.pluckTurn(b,c),c=a.pluckTurn(c,d);if(f*c<0)return!1;d=a.pluckTurn(d,e);return f*d<0?!1:a.pluckTurn(e,b)*f>=0},intersectQuadDist:function(b,c,d,e){return!a.intersectQuad(b,c,d,e)?!1:(c=a.intersectTri([b,c,d]))?c:a.intersectTri([b,d,e])},intersectSphere:function(b){var c=a.objectOrigin,b=lib_vector3D.dot(c,
c)-b*b,c=lib_vector3D.dot(c,a.objectDirection);return c*c-b>=0},intersectTri:function(b){var c=a.pluckTurn(b[0],b[1]),d=a.pluckTurn(b[1],b[2]);if(c*d<0)return!1;if(a.pluckTurn(b[2],b[0])*c<0)return!1;var c=lib_vector3D.subNew(b[0],b[1]),d=lib_vector3D.subNew(b[0],b[2]),b=lib_vector3D.subNew(b[0],a.objectOrigin),e=lib_vector3D.det(a.objectDirection,c,d);return-lib_vector3D.det(b,c,d)/e}};return a},RAY=Ray(),Cube=function(a){var b={type:"cube",cornerA:[a.min[0],a.min[1],a.min[2]],cornerB:[a.max[0],
a.min[1],a.min[2]],cornerC:[a.max[0],a.max[1],a.min[2]],cornerD:[a.min[0],a.max[1],a.min[2]],cornerE:[a.min[0],a.min[1],a.max[2]],cornerF:[a.max[0],a.min[1],a.max[2]],cornerG:[a.max[0],a.max[1],a.max[2]],cornerH:[a.min[0],a.max[1],a.max[2]],center:[0.5*(a.min[0]+a.max[0]),0.5*(a.min[1]+a.max[1]),0.5*(a.min[2]+a.max[2])],pick:function(a){return a.intersectQuad(b.cornerA,b.cornerB,b.cornerC,b.cornerD)?b.center:a.intersectQuad(b.cornerA,b.cornerB,b.cornerF,b.cornerE)?b.center:a.intersectQuad(b.cornerB,
b.cornerC,b.cornerG,b.cornerF)?b.center:a.intersectQuad(b.cornerC,b.cornerD,b.cornerH,b.cornerG)?b.center:a.intersectQuad(b.cornerA,b.cornerD,b.cornerH,b.cornerE)?b.center:!1}};return b},Octree=function(a){var b={type:"Octree",hasNoFaces:a.jsonOctree.f===0,hasChilds:a.jsonOctree.childs!==0,init:function(){if(b.hasNoFaces&&b.hasChilds){b.childs=[];b.cube=Cube({min:a.jsonOctree.min,max:a.jsonOctree.max});b.numChilds=a.jsonOctree.childs.length;for(var c=0;c<b.numChilds;c++)b.childs.push(Octree({mesh:a.mesh,
jsonOctree:a.jsonOctree.childs[c]}))}else b.faces=a.jsonOctree.f},pick:function(c){var d=!1;if(b.hasNoFaces){if(!b.hasChilds)return!1;if(b.cube.pick(c))for(var e=0;e<b.numChilds;e++)if(d=b.childs[e].pick(c))return d}else for(e=0;e<b.faces.length;e++)if(d=c.intersectTri(a.mesh.getFace(b.faces[e])))return d;return!1}};b.init();return b},QuadCollider=function(a){return{pick:function(b){return b.intersectQuadDist(a.A,a.B,a.C,a.D)}}},GAME={},DEBUG=!0,VIDEOSCREEN,GROUND,Game=function(a){var b={rootDir:a.rootDir||
"",playerWhite:!0,camWhite:[7,0,-5],thetaWhite:Math.PI/2,phi:8.4,started:!1,infosChess:lib_dom.get("infosChess"),isInChess:!1,msgStack:[],msgRcvStack:[],msgCounter:0,chessmate:!1,load:function(){var c=View({cam:b.camWhite,theta:b.thetaWhite,phi:b.phi});c.computeR();Context3D({view:c,canvasId:a.canvasId,fullscreen:a.fullscreen});b.loaded()},loaded:function(){Chess();Webrtc();GROUND=Obj({mesh:Quad({h:50,w:50,textureScale:20}),texture:Texture({imageURL:"engine3D/ressources/ground.jpg"}),render:Renders.ground});
GROUND.setPos([0,0,-4]);VIDEOSCREEN=VideoScreenObj({w:3.8,h:2.8,position:[2.5,0,1.5],videoElt:document.getElementById("remoteView"),def:512})},hideConnectWin:function(){CONTEXT3D.cv.style.webkitFilter="";lib_dom.hide("connectWin")},handleMsg:function(a,d){var e=a.split(":");if(e[0]!=="CHESS")return!1;var f=e.length>2?e[2].split(","):!1;switch(e[1]){case "UP":if(b.isMsgRcv(parseInt(e[3])))return!1;CHESS.game[parseInt(f[0])][parseInt(f[1])].putUp(!1);break;case "DOWN":if(b.isMsgRcv(parseInt(e[3])))return!1;
CHESS.game[parseInt(f[0])][parseInt(f[1])].putDown(!1);break;case "MOVE":if(b.isMsgRcv(parseInt(e[3])))return!1;CHESS.game[parseInt(f[0])][parseInt(f[1])].move([parseInt(f[2]),parseInt(f[3])],CHESS.getChessman([parseInt(f[2]),parseInt(f[3])]),!1);break;case "ISBUSY":WEBRTC.sendToPeer(d,"CHESS:"+(b.started?"IAMBUSY":"IAMFREE")+":"+WEBRTC.get_myName());break;case "IAMFREE":WEBRTC.freeCallback(d,f[0]);break;case "IAMBUSY":WEBRTC.busyCallback();break;case "ACK":e=parseInt(e[2]);lib_array.removeElement(b.msgStack,
e);break;case "RESTART":console.log("restart",e[2]);if(b.isMsgRcv(parseInt(e[2])))return!1;console.log("ask restart");b.askRestart()?(b.sendMsg("CHESS:DORESTART"),b.doRestart()):b.sendMsg("CHESS:DONOTRESTART");break;case "DORESTART":if(b.isMsgRcv(parseInt(e[2])))return!1;b.doRestart();break;case "DONOTRESTART":if(b.isMsgRcv(parseInt(e[2])))return!1;alert("Your partner do not want to restart the game.")}return!0},isMsgRcv:function(a){if(b.msgRcvStack.indexOf(a)!=-1)return!0;b.sendAck(a);b.msgRcvStack.push(a);
return!1},sendMsg:function(a){b.msgStack.push(b.msgCounter);a=a+":"+b.msgCounter;WEBRTC.sendMsg(a);setTimeout(b.checkAck,200,b.msgCounter,a);b.msgCounter++},checkAck:function(a,d){if(b.msgStack.indexOf(a)==-1)return!0;WEBRTC.sendMsg(d);setTimeout(b.checkAck,200,a,d)},sendAck:function(a){WEBRTC.sendMsg("CHESS:ACK:"+a)},setBlack:function(){b.playerWhite=!1},setWhite:function(){b.playerWhite=!0},start:function(){b.hideConnectWin();b.playerWhite?GL.enable(GL.CULL_FACE):(VIEW.rotate_soft(Math.PI,2E3),
VIDEOSCREEN.rotate_soft(0,Math.PI,2E3),TOWERLEFT.swiftSide(),TOWERRIGHT.swiftSide(),GL.disable(GL.CULL_FACE));b.started=!0},askRestart:function(){return confirm("Do you really want to restart the game ?")},restart:function(){b.started&&b.askRestart()&&(console.log("send restart"),b.sendMsg("CHESS:RESTART"))},doRestart:function(){b.chessmate=!1;CHESS.doRestart();b.started=!0},chessAlert:function(a){if(b.isInChess&&a||!b.isInChess&&!a)return!1;a?(infosChess.innerHTML="CHESS",infosChess.style.backgroundColor=
"red"):(infosChess.innerHTML="",infosChess.style.backgroundColor="white");b.isInChess=a},over:function(){b.chessmate=!0;infosChess.innerHTML="CHESSMATE";infosChess.style.backgroundColor="red"},troubleshooting:function(){window.location.href="troubleshooting.php"}};return GAME=b};Engine3D.params={fr:25,angle:30,zNear:0.2,zFar:40,viewH:1.7,step:0.2,stepTheta:0.02,mouse_sensitivityX:0.0015,mouse_sensitivityY:0.0015};
var CHESS,TABLE,TOWERLEFT,TOWERRIGHT,Chess=function(){var a={offset:[-2,-2,0],size:[4,4],rackDist:0.25,current_chessman:!1,white_chessmen:[],black_chessmen:[],get_position:function(b){return[a.offset[0]+b[0]*a.squareSize[0]+a.halfSquareSize[0],a.offset[1]+b[1]*a.squareSize[1]+a.halfSquareSize[1],a.offset[2]]},checkChessMate:function(b){var c=b?a.white_chessmen:a.black_chessmen,d,e,f;for(d=0;d<c.length;d++)if(c[d].alive)for(e=0;e<8;e++)for(f=0;f<8;f++)if(!(e==c[d].pos[0]&&f==c[d].pos[1])&&c[d].checkPos([e,
f],!1)&&!a.checkChess(b,c[d],[e,f]))return!1;return!0},checkChess:function(b,c,d){var e=b?a.black_chessmen:a.white_chessmen,f,g,i,k=b?a.white_king:a.black_king;g=[c.pos[0],c.pos[1]];c.pos=d;i=a.game[d[0]][d[1]];a.game[d[0]][d[1]]=c;a.game[g[0]][g[1]]=!1;var h=function(){a.game[d[0]][d[1]]=i;a.game[g[0]][g[1]]=c;c.pos=g};for(f=0;f<e.length;f++)if(b=e[f],b.alive&&i!=b&&b.checkPos(k.pos,!1))return h(),!0;h();return!1},checkPos:function(b){return b[0]<0||b[0]>7||b[1]<0||b[1]>7?!1:!a.game[b[0]][b[1]]?
!0:!1},eat:function(b,c,d){if(c[0]<0||c[0]>7||c[1]<0||c[1]>7)return!1;var e=a.game[c[0]][c[1]];return a.playerWhite===b.get_white()&&a.checkChess(a.playerWhite,b,c)?!1:!e?!d:e.get_white()===b.get_white()?!1:e},getChessman:function(b){return a.game[b[0]][b[1]]===!1?!0:a.game[b[0]][b[1]]},doRestart:function(){var b,c;a.playerWhite=!0;a.current_chessman=!1;for(b=0;b<8;b++)for(c=0;c<8;c++)a.game[b][c]=!1;for(b=0;b<SCENE.obj_middle.length;b++)SCENE.obj_middle[b].reset&&SCENE.obj_middle[b].reset()},start:function(){a.playerWhite=
!0;a.rack=0},init:function(){a.squareSize=[a.size[0]/8,a.size[1]/8];a.halfSquareSize=[a.squareSize[0]/2,a.squareSize[1]/2];a.texture_pawn=Texture({imageURL:"engine3D/ressources/chess/Pawn/bake.png"});a.texture_rook=Texture({imageURL:"engine3D/ressources/chess/Rook/bake.png"});a.texture_knight=Texture({imageURL:"engine3D/ressources/chess/Knight/bake.png"});a.texture_bishop=Texture({imageURL:"engine3D/ressources/chess/Bishop/bake.png"});a.texture_king=Texture({imageURL:"engine3D/ressources/chess/King/bake.png"});
a.texture_queen=Texture({imageURL:"engine3D/ressources/chess/Queen/bake.png"});a.start();a.white_king=King({white:!0,pos:[0,3]});a.black_king=King({white:!1,pos:[7,3]});a.game=[[Rook({white:!0,pos:[0,0]}),Knight({white:!0,pos:[0,1]}),Bishop({white:!0,pos:[0,2]}),a.white_king,Queen({white:!0,pos:[0,4]}),Bishop({white:!0,pos:[0,5]}),Knight({white:!0,pos:[0,6]}),Rook({white:!0,pos:[0,7]})],[Pawn({white:!0,pos:[1,0]}),Pawn({white:!0,pos:[1,1]}),Pawn({white:!0,pos:[1,2]}),Pawn({white:!0,pos:[1,3]}),Pawn({white:!0,
pos:[1,4]}),Pawn({white:!0,pos:[1,5]}),Pawn({white:!0,pos:[1,6]}),Pawn({white:!0,pos:[1,7]})],[!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!1,!1,!1],[Pawn({white:!1,pos:[6,0]}),Pawn({white:!1,pos:[6,1]}),Pawn({white:!1,pos:[6,2]}),Pawn({white:!1,pos:[6,3]}),Pawn({white:!1,pos:[6,4]}),Pawn({white:!1,pos:[6,5]}),Pawn({white:!1,pos:[6,6]}),Pawn({white:!1,pos:[6,7]})],[Rook({white:!1,pos:[7,0]}),Knight({white:!1,pos:[7,1]}),Bishop({white:!1,pos:[7,2]}),
a.black_king,Queen({white:!1,pos:[7,4]}),Bishop({white:!1,pos:[7,5]}),Knight({white:!1,pos:[7,6]}),Rook({white:!1,pos:[7,7]})]];a.textureWhite=Texture({imageURL:"engine3D/ressources/chess/white.jpg"});a.textureBlack=Texture({imageURL:"engine3D/ressources/chess/black.jpg"});a.towerLeft=Tower({side:1});a.towerRight=Tower({side:-1});a.board=Chessboard();var b=lib_matrix_base4.getI4();lib_matrix_mv.setPos(b,[0,0,-0.2]);TABLE=JSONobj({textureURL:"engine3D/ressources/Board/wood.jpg",jsonURL:"engine3D/ressources/Board/board.json",
mvMatrix:b,render:Renders.misc});TOWERLEFT=a.towerLeft;TOWERRIGHT=a.towerRight;a.soundput=Audiotrack({soundURL:"sounds/put.mp3"})},changePlayer:function(){a.playerWhite=!a.playerWhite;a.current_chessman=!1}};CHESS=a;a.init()},Tower=function(a){a.white=!1;var b=lib_matrix_base4.getI4();lib_matrix_mv.setPos(b,[CHESS.size[0]/2+0.6,(CHESS.size[1]/2+0.2)*a.side,0]);var c=JSONobj({texture:CHESS.textureBlack,jsonURL:"engine3D/ressources/Tower/tower.json",render:Renders.misc,mvMatrix:b});c.swiftSide=function(){a.white?
c.obj.setTexture(CHESS.textureBlack):c.obj.setTexture(CHESS.textureWhite);c.obj.rotate_soft(0,Math.PI,2E3);a.white=!a.white};return c},Chessboard=function(){var a={board:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],init:function(){for(var b=CHESS.textureWhite,c=CHESS.textureBlack,d=CHESS.squareSize[0],e=CHESS.squareSize[1],f=!1,g=[],i=[],k=Quad({w:d,h:e}),h=0;h<8;h++)for(var j=0;j<8;j++){var l=lib_matrix_base4.getI4();
lib_matrix_mv.setPos(l,[CHESS.offset[0]+h*d+d/2,CHESS.offset[1]+j*e+e/2,CHESS.offset[2]]);f=(h+j)%2==0;l=Obj({mesh:k,texture:f?b:c,mvMatrix:l,render:Renders.board});l.octree=QuadCollider({A:[-d/2,-e/2,0],B:[d/2,-e/2,0],C:[d/2,e/2,0],D:[-d/2,e/2,0]});l.pickable=!0;l.ij=[h,j];l.setdoPick(function(){if(CHESS.current_chessman){var a=CHESS.current_chessman.checkPos(this.ij,!0);if(!a)return!1;CHESS.current_chessman.move(this.ij,a,!0)}else return(a=CHESS.game[this.ij[0]][this.ij[1]])?a.doPick():!1});a.board[h][j]=
l;f?i.push(a.board[h][j]):g.push(a.board[h][j])}SCENE.obj_square=i.concat(g);SCENE.obj_pickable=SCENE.obj_pickable.concat(i).concat(g)}};a.init();return a},Chessman=function(a){a.theta=a.theta||0;var b=lib_matrix_base4.getI4();lib_matrix_rot.rotateZFast(b,a.theta);a.v=CHESS.get_position(a.pos);lib_matrix_mv.setPos(b,a.v);var c=JSONobj({texture:a.texture,jsonURL:a.json,mvMatrix:b,render:Renders.chessman,white:a.white?1:0});c.get_white=function(){return a.white};c.white=a.white;c.set=function(){c.alive=
!0;c.firstTime=!0;c.pos=[a.pos[0],a.pos[1]]};c.reset=function(){a.v=CHESS.get_position(a.pos);CHESS.game[a.pos[0]][a.pos[1]]=c;(a.pos[0]!=c.pos[0]||a.pos[1]!=c.pos[1])&&c.obj.move_parabollic(CHESS.get_position(a.pos),1,500,99,function(){});c.set()};c.set();c.doPick=function(){if(GAME.chessmate)return!1;if(CHESS.current_chessman){if(c==CHESS.current_chessman)return c.putDown(!0),CHESS.current_chessman=!1,!0;if(a.white===CHESS.playerWhite)CHESS.current_chessman.putDown(!0);else return CHESS.board.board[c.pos[0]][c.pos[1]].doPick(),
!0}if(CHESS.playerWhite===a.white&&GAME.playerWhite==a.white)return c.putUp(!0),CHESS.current_chessman=c,!0};c.putDown=function(d){a.v[2]=CHESS.offset[2];lib_matrix_mv.setPos(b,a.v);d&&GAME.sendMsg("CHESS:DOWN:"+c.pos[0]+","+c.pos[1])};c.putUp=function(d){a.v[2]=CHESS.offset[2]+0.2;lib_matrix_mv.setPos(b,a.v);d&&GAME.sendMsg("CHESS:UP:"+c.pos[0]+","+c.pos[1])};c.move=function(b,e,f){e=e===!0?function(){return!0}:e.eaten;c.obj.move_parabollic(CHESS.get_position(b),0.5,500,0.2,e);setTimeout(CHESS.soundput.play,
900);CHESS.game[c.pos[0]][c.pos[1]]=!1;CHESS.game[b[0]][b[1]]=c;f&&GAME.sendMsg("CHESS:MOVE:"+c.pos[0]+","+c.pos[1]+","+b[0]+","+b[1]);c.pos=[b[0],b[1]];if(c.checkPos((a.white?CHESS.black_king:CHESS.white_king).pos,!1)){if(CHESS.checkChessMate(!a.white))return GAME.over(),!1;CHESS.playerWhite==GAME.playerWhite?VIDEOSCREEN.setColor(!0):GAME.chessAlert(!0)}else VIDEOSCREEN.setColor(!1),GAME.chessAlert(!1);a.v=CHESS.get_position(c.pos);CHESS.changePlayer();c.firstTime=!1};c.eaten=function(){var b=a.white?
-CHESS.size[0]/2-CHESS.rackDist:CHESS.rackDist+CHESS.size[0]/2,e=a.white?-CHESS.size[0]/2+CHESS.size[0]/16+CHESS.rack*CHESS.size[0]/16:CHESS.size[0]/2-CHESS.size[0]/16-CHESS.rack*CHESS.size[0]/16;CHESS.rack++;c.obj.move_parabollic([e,b,CHESS.offset[2]],2,500);c.alive=!1};a.white?CHESS.white_chessmen.push(c):CHESS.black_chessmen.push(c);SCENE.addObjChessman(c);SCENE.addPickable(c);SCENE.addObjShadow(c);return c},Bishop=function(a){var b=Chessman({json:"engine3D/ressources/chess/Bishop/bishop.json",
pos:a.pos,texture:CHESS.texture_bishop,white:a.white,theta:a.white?Math.PI/2:-Math.PI/2});b.numType=3;b.checkPos=function(a,d){if(Math.abs(b.pos[0]-a[0])!=Math.abs(b.pos[1]-a[1]))return!1;for(var e=Math.abs(b.pos[0]-a[0]),f=b.pos[0]<a[0]?1:-1,g=b.pos[1]<a[1]?1:-1,i,k=1;k<e;k++)if(i=[b.pos[0]+f*k,b.pos[1]+g*k],!CHESS.checkPos(i))return!1;return!d?!0:CHESS.eat(b,a,!1)};return b},King=function(a){var b=Chessman({json:"engine3D/ressources/chess/King/king.json",texture:CHESS.texture_king,pos:a.pos,white:a.white});
b.numType=5;b.checkPos=function(a,d){return Math.abs(a[0]-b.pos[0])>1?!1:Math.abs(a[1]-b.pos[1])>1?!1:!d?!0:CHESS.eat(b,a,!1)};return b},Knight=function(a){var b=Chessman({json:"engine3D/ressources/chess/Knight/knight.json",texture:CHESS.texture_knight,pos:a.pos,white:a.white,theta:a.white?0:Math.PI});b.numType=2;b.checkPos=function(a,d){return!(Math.abs(a[0]-b.pos[0])==2&&Math.abs(a[1]-b.pos[1])==1||Math.abs(a[1]-b.pos[1])==2&&Math.abs(a[0]-b.pos[0])==1)?!1:!d?!0:CHESS.eat(b,a,!1)};return b},Pawn=
function(a){var b=Chessman({json:"engine3D/ressources/chess/Pawn/pawn.json",texture:CHESS.texture_pawn,pos:a.pos,white:a.white});b.numType=0;b.checkPos=function(c,d){var e=a.white?1:-1;return c[1]==b.pos[1]&&c[0]==b.pos[0]+e?!CHESS.checkPos(c)?!1:!CHESS.checkChess(a.white,b,c):c[1]==b.pos[1]&&c[0]==b.pos[0]+2*e&&b.firstTime?!CHESS.checkPos(c)?!1:!CHESS.checkChess(a.white,b,c):(c[1]==b.pos[1]+1||c[1]==b.pos[1]-1)&&c[0]==b.pos[0]+e?!d?!0:CHESS.eat(b,c,!0):!1};return b},Queen=function(a){var b=Chessman({json:"engine3D/ressources/chess/Queen/queen.json",
texture:CHESS.texture_queen,pos:a.pos,white:a.white});b.numType=4;b.checkPos=function(a,d){if(a[0]!=b.pos[0]&&a[1]!=b.pos[1]&&Math.abs(b.pos[0]-a[0])!=Math.abs(b.pos[1]-a[1]))return!1;if(a[0]==b.pos[0]||a[1]==b.pos[1])for(var e=a[0]==b.pos[0]?1:0,f=b.pos[e]<a[e]?1:-1,g,i=1;i<Math.abs(b.pos[e]-a[e]);i++){if(g=e==0?[b.pos[e]+i*f,b.pos[1]]:[b.pos[0],b.pos[e]+i*f],!CHESS.checkPos(g))return!1}else{e=Math.abs(b.pos[0]-a[0]);f=b.pos[0]<a[0]?1:-1;g=b.pos[1]<a[1]?1:-1;for(var k,i=1;i<e;i++)if(k=[b.pos[0]+
f*i,b.pos[1]+g*i],!CHESS.checkPos(k))return!1}return!d?!0:CHESS.eat(b,a,!1)};return b},Rook=function(a){var b=Chessman({json:"engine3D/ressources/chess/Rook/rook.json",texture:CHESS.texture_rook,pos:a.pos,white:a.white});b.numType=1;b.checkPos=function(a,d){if(a[0]!=b.pos[0]&&a[1]!=b.pos[1])return!1;for(var e=a[0]==b.pos[0]?1:0,f=b.pos[e]<a[e]?1:-1,g,i=1;i<Math.abs(b.pos[e]-a[e]);i++)if(g=e==0?[b.pos[e]+i*f,b.pos[1]]:[b.pos[0],b.pos[e]+i*f],!CHESS.checkPos(g))return!1;return!d?!0:CHESS.eat(b,a,!1)};
return b};
